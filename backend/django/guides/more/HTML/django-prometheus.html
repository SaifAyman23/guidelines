<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Ultimate Guide: django-prometheus</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0d;
    --surface: #141414;
    --surface2: #1c1c1c;
    --border: #2a2a2a;
    --text: #e8e6e1;
    --muted: #888;
    --green: #4ade80;
    --amber: #fbbf24;
    --blue: #60a5fa;
    --red: #f87171;
    --purple: #c084fc;
    --orange: #fb923c;
    --accent: #e879f9;
    --accent-dim: rgba(232,121,249,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 16px;
    line-height: 1.7;
  }

  /* NAV */
  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(13,13,13,0.94);
    backdrop-filter: blur(14px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    display: flex; align-items: center; gap: 2rem;
    height: 56px; overflow-x: auto;
  }
  nav a { color: var(--muted); text-decoration: none; font-size: 0.78rem; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; white-space: nowrap; transition: color 0.2s; }
  nav a:hover { color: var(--accent); }
  nav .logo { color: var(--text); font-family: 'DM Serif Display', serif; font-size: 1rem; letter-spacing: 0; text-transform: none; flex-shrink: 0; margin-right: 1rem; }

  /* HERO */
  .hero {
    padding: 6rem 2rem 4rem;
    max-width: 860px; margin: 0 auto; text-align: center;
  }
  .hero-label {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; font-weight: 700; letter-spacing: 0.18em; text-transform: uppercase;
    color: var(--accent); background: var(--accent-dim); border: 1px solid rgba(232,121,249,0.2);
    padding: 0.3rem 1rem; border-radius: 4px; margin-bottom: 2rem;
  }
  h1 { font-family: 'DM Serif Display', serif; font-size: clamp(2.5rem, 6vw, 4.5rem); line-height: 1.1; font-weight: 400; margin-bottom: 1.5rem; letter-spacing: -0.01em; }
  h1 em { font-style: italic; color: var(--accent); }
  .hero p { font-size: 1.15rem; color: var(--muted); max-width: 600px; margin: 0 auto 3rem; line-height: 1.8; }

  /* CONTENT */
  .content { max-width: 860px; margin: 0 auto; padding: 0 2rem 8rem; }
  section { margin-bottom: 5rem; scroll-margin-top: 80px; }
  h2 { font-family: 'DM Serif Display', serif; font-size: 2rem; font-weight: 400; margin-bottom: 0.5rem; letter-spacing: -0.01em; line-height: 1.2; }
  h3 { font-size: 1.05rem; font-weight: 600; margin-bottom: 0.75rem; margin-top: 2rem; color: var(--text); letter-spacing: 0.01em; }
  h4 { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; margin-top: 1.5rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; font-family: 'JetBrains Mono', monospace; }

  .section-label { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; display: block; }
  .divider { width: 40px; height: 2px; background: var(--accent); margin: 1rem 0 2rem; }
  p { margin-bottom: 1.2rem; color: #c5c2ba; }

  /* CODE */
  .code-block { background: #0a0a0a; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin: 1.5rem 0; font-size: 0.875rem; }
  .code-header { background: #111; border-bottom: 1px solid var(--border); padding: 0.6rem 1.2rem; display: flex; justify-content: space-between; align-items: center; }
  .code-header span { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
  .copy-btn { background: none; border: 1px solid var(--border); color: var(--muted); font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; padding: 0.2rem 0.6rem; border-radius: 4px; cursor: pointer; letter-spacing: 0.06em; text-transform: uppercase; transition: all 0.2s; }
  .copy-btn:hover { color: var(--accent); border-color: var(--accent); }
  pre { padding: 1.5rem; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; line-height: 1.7; tab-size: 4; }
  code { font-family: 'JetBrains Mono', monospace; font-size: 0.85em; background: rgba(255,255,255,0.06); padding: 0.15em 0.45em; border-radius: 3px; color: var(--amber); }
  pre code { background: none; padding: 0; color: var(--text); font-size: 1em; }

  .k { color: #c084fc; }
  .s { color: #4ade80; }
  .c { color: #444; font-style: italic; }
  .n { color: #60a5fa; }
  .m { color: #fbbf24; }
  .pq { color: #e879f9; }
  .comment-line { color: #444; font-style: italic; }
  .hl { color: var(--amber); }
  .hl2 { color: var(--blue); }
  .hl3 { color: var(--green); }
  .hl4 { color: var(--accent); }

  /* CALLOUTS */
  .callout { border-radius: 8px; padding: 1.25rem 1.5rem; margin: 1.5rem 0; border-left: 3px solid; font-size: 0.95rem; }
  .callout.info  { background: rgba(96,165,250,0.06);  border-color: var(--blue);   }
  .callout.warning { background: rgba(251,191,36,0.06); border-color: var(--amber); }
  .callout.tip   { background: rgba(74,222,128,0.06);  border-color: var(--green);  }
  .callout.danger{ background: rgba(248,113,113,0.06); border-color: var(--red);    }
  .callout.purple{ background: rgba(192,132,252,0.06); border-color: var(--purple); }
  .callout strong { font-size: 0.72rem; font-family: 'JetBrains Mono', monospace; letter-spacing: 0.1em; text-transform: uppercase; display: block; margin-bottom: 0.4rem; }
  .callout.info  strong { color: var(--blue); }
  .callout.warning strong { color: var(--amber); }
  .callout.tip   strong { color: var(--green); }
  .callout.danger strong { color: var(--red); }
  .callout.purple strong { color: var(--purple); }
  .callout p { margin: 0; color: #b5b2aa; }

  /* TABLE */
  .data-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; margin: 1.5rem 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
  .data-table th { background: #111; padding: 0.8rem 1rem; text-align: left; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.06em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; }
  .data-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #1a1a1a; vertical-align: top; color: #c5c2ba; }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table td:first-child { font-family: 'JetBrains Mono', monospace; font-size: 0.82rem; color: var(--amber); white-space: nowrap; }
  .data-table td:nth-child(2) { color: var(--purple); font-size: 0.82rem; }
  .data-table tr:hover td { background: rgba(255,255,255,0.02); }

  /* BADGE */
  .badge { display: inline-block; font-size: 0.68rem; font-family: 'JetBrains Mono', monospace; padding: 0.15rem 0.5rem; border-radius: 3px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; }
  .badge.counter  { background: rgba(251,191,36,0.12);  color: var(--amber);  }
  .badge.gauge    { background: rgba(96,165,250,0.12);   color: var(--blue);   }
  .badge.histo    { background: rgba(74,222,128,0.12);   color: var(--green);  }
  .badge.summary  { background: rgba(192,132,252,0.12);  color: var(--purple); }

  /* TWO COL */
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem; margin: 1.5rem 0; }
  @media (max-width: 640px) { .two-col { grid-template-columns: 1fr; } }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; }
  .card h4 { font-size: 0.92rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); color: var(--text); text-transform: none; letter-spacing: 0; font-family: 'DM Sans', sans-serif; }
  .card ul { list-style: none; }
  .card ul li { padding: 0.35rem 0; font-size: 0.88rem; color: #aaa; display: flex; gap: 0.6rem; }
  .card ul li::before { content: '—'; color: var(--border); flex-shrink: 0; }

  /* METRIC TYPE CARDS */
  .metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 2rem 0; }
  @media (max-width: 640px) { .metric-grid { grid-template-columns: 1fr; } }
  .metric-card { border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; position: relative; overflow: hidden; }
  .metric-card::before { content: ''; position: absolute; inset: 0; opacity: 0.03; }
  .metric-card.counter { border-top: 2px solid var(--amber); }
  .metric-card.gauge   { border-top: 2px solid var(--blue);  }
  .metric-card.histo   { border-top: 2px solid var(--green); }
  .metric-card.summ    { border-top: 2px solid var(--purple);}
  .metric-card h4 { font-family: 'DM Serif Display', serif; font-size: 1.3rem; font-weight: 400; margin-bottom: 0.3rem; margin-top: 0; text-transform: none; letter-spacing: 0; }
  .metric-card.counter h4 { color: var(--amber); }
  .metric-card.gauge   h4 { color: var(--blue);  }
  .metric-card.histo   h4 { color: var(--green); }
  .metric-card.summ    h4 { color: var(--purple);}
  .metric-card p { font-size: 0.88rem; color: #888; margin-bottom: 0.75rem; }
  .metric-card .use { font-size: 0.78rem; color: #aaa; }
  .metric-card .use strong { color: var(--text); font-size: 0.78rem; }

  /* ARCHITECTURE DIAGRAM */
  .arch { background: #0a0a0a; border: 1px solid var(--border); border-radius: 10px; padding: 2rem; margin: 2rem 0; }
  .arch-title { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--muted); margin-bottom: 2rem; }

  .pull-diagram { display: flex; align-items: center; gap: 0; justify-content: center; flex-wrap: wrap; gap: 0; }
  .arch-node { border: 1.5px solid; border-radius: 6px; padding: 0.75rem 1.25rem; text-align: center; font-size: 0.85rem; font-weight: 600; min-width: 150px; }
  .arch-node small { display: block; font-size: 0.68rem; font-weight: 400; opacity: 0.7; margin-top: 0.15rem; font-family: 'JetBrains Mono', monospace; }
  .arch-node.django  { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
  .arch-node.prom    { border-color: var(--orange); color: var(--orange); background: rgba(251,146,60,0.06); }
  .arch-node.grafana { border-color: var(--amber); color: var(--amber); background: rgba(251,191,36,0.06); }
  .arch-node.client  { border-color: #555; color: #aaa; background: #111; }

  .arch-arrow-h { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 0.75rem; }
  .arch-arrow-h .line { width: 50px; height: 1px; background: var(--border); }
  .arch-arrow-h .arrow-label { font-size: 0.65rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 0.3rem; white-space: nowrap; }
  .arch-arrow-h .arrowhead { color: var(--border); font-size: 10px; }

  .layer-diagram { display: flex; flex-direction: column; gap: 1px; }
  .layer { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem; border: 1px solid var(--border); border-radius: 6px; }
  .layer:first-child { border-color: rgba(232,121,249,0.3); background: rgba(232,121,249,0.03); }
  .layer:nth-child(2) { border-color: rgba(251,146,60,0.3); background: rgba(251,146,60,0.03); }
  .layer:nth-child(3) { border-color: rgba(251,191,36,0.3); background: rgba(251,191,36,0.03); }
  .layer-num { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.5rem; border-radius: 3px; flex-shrink: 0; }
  .layer:first-child .layer-num { background: rgba(232,121,249,0.12); color: var(--accent); }
  .layer:nth-child(2) .layer-num { background: rgba(251,146,60,0.12); color: var(--orange); }
  .layer:nth-child(3) .layer-num { background: rgba(251,191,36,0.12); color: var(--amber); }
  .layer-content h5 { font-size: 0.88rem; font-weight: 600; margin-bottom: 0.15rem; color: var(--text); }
  .layer-content p { font-size: 0.82rem; color: var(--muted); margin: 0; }

  /* MULTIPROC DIAGRAM */
  .mp-diagram { display: flex; flex-direction: column; align-items: center; gap: 0; }
  .mp-row { display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap; }
  .mp-box { border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem 0.9rem; font-size: 0.78rem; font-family: 'JetBrains Mono', monospace; text-align: center; }
  .mp-box small { display: block; font-size: 0.65rem; opacity: 0.6; margin-top: 0.1rem; }
  .mp-box.worker { border-color: rgba(96,165,250,0.4); color: var(--blue); background: rgba(96,165,250,0.04); }
  .mp-box.dir { border-color: rgba(74,222,128,0.4); color: var(--green); background: rgba(74,222,128,0.04); min-width: 240px; }
  .mp-box.prom { border-color: rgba(251,146,60,0.4); color: var(--orange); background: rgba(251,146,60,0.04); }
  .mp-arrow-v { width: 1px; height: 24px; background: var(--border); margin: 0 auto; position: relative; }
  .mp-arrow-v::after { content: '▼'; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); font-size: 9px; color: var(--border); }
  .mp-label { font-size: 0.68rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; text-align: center; margin: 4px 0; }

  /* TOC */
  .toc { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem 2rem; margin-bottom: 4rem; }
  .toc h3 { font-family: 'DM Serif Display', serif; font-weight: 400; font-size: 1.1rem; margin-top: 0; margin-bottom: 1rem; color: var(--text); }
  .toc ol { padding-left: 1.2rem; columns: 2; column-gap: 2rem; }
  @media (max-width: 640px) { .toc ol { columns: 1; } }
  .toc ol li { margin-bottom: 0.4rem; break-inside: avoid; }
  .toc a { color: var(--muted); text-decoration: none; font-size: 0.86rem; transition: color 0.2s; }
  .toc a:hover { color: var(--accent); }

  /* STEPS */
  .steps { counter-reset: step; }
  .step { position: relative; padding-left: 3.5rem; margin-bottom: 2.5rem; }
  .step::before { counter-increment: step; content: counter(step); position: absolute; left: 0; top: 0.1rem; width: 2rem; height: 2rem; background: var(--accent); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; font-family: 'JetBrains Mono', monospace; }
  .step h3 { margin-top: 0; }

  /* CHECKLIST */
  .checklist { list-style: none; }
  .checklist li { padding: 0.5rem 0; border-bottom: 1px solid #1a1a1a; font-size: 0.9rem; color: #bbb; display: flex; align-items: flex-start; gap: 0.75rem; }
  .checklist li:last-child { border-bottom: none; }
  .checklist li::before { content: '☐'; font-size: 1rem; line-height: 1.3; flex-shrink: 0; color: var(--border); }
  .checklist-group { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem 1.5rem; margin: 1rem 0; }
  .checklist-group h4 { font-size: 0.75rem; font-family: 'JetBrains Mono', monospace; color: var(--accent); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 0.75rem; margin-top: 0; border-bottom: none; padding-bottom: 0; }

  /* PROMQL box */
  .promql-box { background: #080812; border: 1px solid rgba(96,165,250,0.2); border-radius: 8px; overflow: hidden; margin: 1.2rem 0; }
  .promql-header { background: rgba(96,165,250,0.06); border-bottom: 1px solid rgba(96,165,250,0.15); padding: 0.5rem 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.68rem; color: var(--blue); letter-spacing: 0.1em; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
  .promql-box pre { padding: 1.25rem; color: var(--blue); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; line-height: 1.7; }
  .promql-box .comment-line { color: #334; }
  .promql-box .fn { color: var(--accent); }
  .promql-box .label-sel { color: var(--green); }
  .promql-box .op { color: var(--amber); }
  .promql-box .num { color: var(--orange); }

  /* RED/USE boxes */
  .method-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
  @media (max-width: 640px) { .method-grid { grid-template-columns: 1fr; } }
  .method-card { border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; }
  .method-card h4 { font-family: 'DM Serif Display', serif; font-size: 1.15rem; font-weight: 400; margin-bottom: 0.5rem; margin-top: 0; text-transform: none; letter-spacing: 0; border-bottom: none; padding-bottom: 0; }
  .method-card.red { border-top: 2px solid var(--red); }
  .method-card.red h4 { color: var(--red); }
  .method-card.use { border-top: 2px solid var(--blue); }
  .method-card.use h4 { color: var(--blue); }
  .method-card ul { list-style: none; }
  .method-card ul li { font-size: 0.88rem; color: #aaa; padding: 0.25rem 0; display: flex; gap: 0.5rem; }
  .method-card ul li strong { color: var(--text); }

  strong { color: var(--text); font-weight: 600; }
  footer { border-top: 1px solid var(--border); padding: 2rem; text-align: center; color: var(--muted); font-size: 0.82rem; font-family: 'JetBrains Mono', monospace; }
  @media (max-width: 640px) { h1 { font-size: 2.2rem; } h2 { font-size: 1.6rem; } .hero { padding: 4rem 1.5rem 3rem; } }
</style>
</head>
<body>

<nav>
  <span class="logo">Django Monitoring</span>
  <a href="#bigpicture">Architecture</a>
  <a href="#install">Install</a>
  <a href="#settings">Settings</a>
  <a href="#metrics">Built-in Metrics</a>
  <a href="#types">Metric Types</a>
  <a href="#custom">Custom Metrics</a>
  <a href="#labels">Labels</a>
  <a href="#multiproc">Multi-Process</a>
  <a href="#security">Security</a>
  <a href="#promql">PromQL</a>
  <a href="#alerting">Alerting</a>
  <a href="#grafana">Grafana</a>
  <a href="#docker">Docker</a>
  <a href="#checklist">Checklist</a>
</nav>

<div class="hero">
  <div class="hero-label">Ultimate Guide — #2 of 6</div>
  <h1>django-<em>prometheus</em></h1>
  <p>A complete, production-focused reference for instrumenting Django with Prometheus. Covers every metric type, PromQL, Grafana dashboards, the multi-process problem, and production hardening.</p>
</div>

<div class="content">

  <!-- TOC -->
  <div class="toc">
    <h3>Table of Contents</h3>
    <ol>
      <li><a href="#bigpicture">The Big Picture</a></li>
      <li><a href="#install">Installation</a></li>
      <li><a href="#settings">Settings & Middleware</a></li>
      <li><a href="#endpoint">The /metrics Endpoint</a></li>
      <li><a href="#metrics">Built-in Metrics</a></li>
      <li><a href="#database">Database Monitoring</a></li>
      <li><a href="#cache">Cache Monitoring</a></li>
      <li><a href="#models">Model Monitoring</a></li>
      <li><a href="#types">The Four Metric Types</a></li>
      <li><a href="#custom">Custom Metrics</a></li>
      <li><a href="#labels">Labels & Cardinality</a></li>
      <li><a href="#multiproc">The Multi-Process Problem</a></li>
      <li><a href="#security">Securing /metrics</a></li>
      <li><a href="#prometheus">Prometheus Server Config</a></li>
      <li><a href="#promql">PromQL Queries</a></li>
      <li><a href="#alerting">Alerting Rules</a></li>
      <li><a href="#grafana">Grafana Dashboards</a></li>
      <li><a href="#custom-labels">Custom Middleware Labels</a></li>
      <li><a href="#docker">Docker & Kubernetes</a></li>
      <li><a href="#naming">Naming & Best Practices</a></li>
      <li><a href="#checklist">Checklist</a></li>
    </ol>
  </div>

  <!-- SECTION 1 -->
  <section id="bigpicture">
    <span class="section-label">Section 01</span>
    <h2>The Big Picture</h2>
    <div class="divider"></div>

    <p>Before touching any code, you need to understand the architecture — it is fundamentally different from logging or traditional push-based monitoring.</p>

    <h3>The Pull Model</h3>

    <p>Most monitoring systems work by pushing data: your app sends metrics to a central server. Prometheus inverts this completely. Prometheus <strong>pulls</strong> — it periodically sends an HTTP GET to a <code>/metrics</code> endpoint on your app, reads the current values, and stores them in its time-series database.</p>

    <div class="arch">
      <div class="arch-title">Request flow — Prometheus pulls from your Django app</div>
      <div class="pull-diagram">
        <div class="arch-node django">Django App<small>/metrics endpoint</small></div>
        <div class="arch-arrow-h">
          <div class="line"></div>
          <div class="arrowhead">◀</div>
          <div class="arrow-label">GET /metrics every 15s</div>
        </div>
        <div class="arch-node prom">Prometheus<small>scrapes & stores</small></div>
        <div class="arch-arrow-h">
          <div class="line"></div>
          <div class="arrowhead">◀</div>
          <div class="arrow-label">PromQL queries</div>
        </div>
        <div class="arch-node grafana">Grafana<small>dashboards & alerts</small></div>
      </div>
    </div>

    <p>This means your app does not need to know where Prometheus is — it just exposes <code>/metrics</code>. Prometheus decides the scrape interval. If Prometheus goes down, your app keeps running. When it comes back, scraping resumes.</p>

    <h3>The Three-Layer Stack</h3>

    <div class="arch">
      <div class="arch-title">A complete monitoring setup</div>
      <div class="layer-diagram">
        <div class="layer">
          <span class="layer-num">Layer 1</span>
          <div class="layer-content">
            <h5>Instrumentation — Your Django App</h5>
            <p>django-prometheus handles this layer. Exposes /metrics with all your metric data.</p>
          </div>
        </div>
        <div class="layer">
          <span class="layer-num">Layer 2</span>
          <div class="layer-content">
            <h5>Collection — Prometheus Server</h5>
            <p>Scrapes /metrics every 15s, stores time-series data, evaluates alerting rules.</p>
          </div>
        </div>
        <div class="layer">
          <span class="layer-num">Layer 3</span>
          <div class="layer-content">
            <h5>Visualization — Grafana</h5>
            <p>Reads from Prometheus via PromQL queries, renders dashboards and sends alerts.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="callout info">
      <strong>Scope of this guide</strong>
      <p><code>django-prometheus</code> only handles Layer 1. You still need to run Prometheus and Grafana separately. This guide covers all three layers.</p>
    </div>

    <h3>What /metrics Returns</h3>
    <p>When Prometheus scrapes your app, it gets a plain-text response. Each line is a metric name, labels, and a value:</p>

    <div class="code-block">
      <div class="code-header"><span>example /metrics output</span></div>
      <pre><code><span class="comment-line"># HELP django_http_requests_total_by_method_total Number of requests by method</span>
<span class="comment-line"># TYPE django_http_requests_total_by_method_total counter</span>
django_http_requests_total_by_method_total{method="GET"} 4521.0
django_http_requests_total_by_method_total{method="POST"} 832.0

<span class="comment-line"># HELP django_http_responses_total_by_status_total Responses by status code</span>
<span class="comment-line"># TYPE django_http_responses_total_by_status_total counter</span>
django_http_responses_total_by_status_total{status="200"} 4200.0
django_http_responses_total_by_status_total{status="404"} 102.0
django_http_responses_total_by_status_total{status="500"} 21.0

<span class="comment-line"># HELP django_db_execute_total Total number of DB execute calls</span>
<span class="comment-line"># TYPE django_db_execute_total counter</span>
django_db_execute_total{alias="default",vendor="postgresql"} 89432.0</code></pre>
    </div>
  </section>

  <!-- SECTION 2: INSTALL -->
  <section id="install">
    <span class="section-label">Section 02</span>
    <h2>Installation</h2>
    <div class="divider"></div>

    <div class="code-block">
      <div class="code-header"><span>bash</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="comment-line"># pip</span>
pip install django-prometheus

<span class="comment-line"># uv</span>
uv add django-prometheus

<span class="comment-line"># poetry</span>
poetry add django-prometheus</code></pre>
    </div>

    <div class="callout tip">
      <strong>What gets installed</strong>
      <p>This automatically installs <code>prometheus_client</code> (the official Python Prometheus client) as a dependency. You will use both packages: <code>django_prometheus</code> for Django-specific instrumentation, and <code>prometheus_client</code> directly for your own custom metrics.</p>
    </div>
  </section>

  <!-- SECTION 3: SETTINGS -->
  <section id="settings">
    <span class="section-label">Section 03</span>
    <h2>Settings & Middleware</h2>
    <div class="divider"></div>

    <div class="code-block">
      <div class="code-header"><span>settings/base.py — INSTALLED_APPS</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>INSTALLED_APPS = [
    ...
    <span class="hl3">"django_prometheus"</span>,
    ...
]</code></pre>
    </div>

    <h3>Middleware — Position is Critical</h3>

    <p>The two Prometheus middlewares must be the <strong>outermost pair</strong> in your stack. <code>PrometheusBeforeMiddleware</code> must be first and <code>PrometheusAfterMiddleware</code> must be last. Every middleware between them is timed, and measurements are correct even when inner middlewares raise exceptions.</p>

    <div class="callout danger">
      <strong>Wrong position = wrong data</strong>
      <p>If you place these middlewares anywhere other than absolute first and last, latency measurements will be wrong. You will miss time spent in middlewares outside the pair.</p>
    </div>

    <div class="code-block">
      <div class="code-header"><span>settings/base.py — middleware</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>MIDDLEWARE = [
    <span class="hl3">"django_prometheus.middleware.PrometheusBeforeMiddleware"</span>,  <span class="comment-line"># MUST be first</span>
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
    <span class="hl3">"django_prometheus.middleware.PrometheusAfterMiddleware"</span>,   <span class="comment-line"># MUST be last</span>
]</code></pre>
    </div>

    <h3>Optional Settings</h3>

    <div class="code-block">
      <div class="code-header"><span>settings/base.py — optional configuration</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="comment-line"># Namespace prefix — all auto-generated metrics become myproject_django_*
# Prevents collisions when running multiple apps in the same Prometheus instance</span>
PROMETHEUS_METRIC_NAMESPACE = <span class="hl3">"myproject"</span>

<span class="comment-line"># Latency histogram buckets (in seconds)
# Tune these to match your app's expected latency profile.
# The default buckets below are a reasonable starting point.</span>
PROMETHEUS_LATENCY_BUCKETS = (
    <span class="m">0.010</span>,  <span class="comment-line"># 10ms</span>
    <span class="m">0.025</span>,  <span class="comment-line"># 25ms</span>
    <span class="m">0.050</span>,  <span class="comment-line"># 50ms</span>
    <span class="m">0.100</span>,  <span class="comment-line"># 100ms</span>
    <span class="m">0.250</span>,  <span class="comment-line"># 250ms</span>
    <span class="m">0.500</span>,  <span class="comment-line"># 500ms</span>
    <span class="m">1.000</span>,  <span class="comment-line"># 1s</span>
    <span class="m">2.500</span>,  <span class="comment-line"># 2.5s</span>
    <span class="m">5.000</span>,  <span class="comment-line"># 5s</span>
    <span class="m">10.00</span>,  <span class="comment-line"># 10s</span>
    float(<span class="hl3">"inf"</span>),
)

<span class="comment-line"># Set to False if you run migrations outside the app process</span>
PROMETHEUS_EXPORT_MIGRATIONS = <span class="k">True</span>  <span class="comment-line"># default</span></code></pre>
    </div>
  </section>

  <!-- SECTION 4: ENDPOINT -->
  <section id="endpoint">
    <span class="section-label">Section 04</span>
    <h2>The /metrics Endpoint</h2>
    <div class="divider"></div>

    <div class="code-block">
      <div class="code-header"><span>config/urls.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> django.urls <span class="k">import</span> path, include

urlpatterns = [
    path(<span class="hl3">"admin/"</span>, admin.site.urls),
    path(<span class="hl3">"api/v1/"</span>, include(<span class="hl3">"apps.api.urls"</span>)),

    <span class="comment-line"># Exposes /metrics — the endpoint Prometheus will scrape</span>
    path(<span class="hl3">""</span>, include(<span class="hl3">"django_prometheus.urls"</span>)),

    <span class="comment-line"># Or at a custom path — must update prometheus.yml metrics_path if you do this:</span>
    <span class="comment-line"># path("monitoring/", include("django_prometheus.urls")),</span>
]</code></pre>
    </div>

    <div class="code-block">
      <div class="code-header"><span>bash — verify the endpoint</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>curl http://localhost:8000/metrics

<span class="comment-line"># You'll see hundreds of lines like:</span>
<span class="comment-line"># # HELP django_http_requests_total_by_method_total ...</span>
<span class="comment-line"># django_http_requests_total_by_method_total{method="GET"} 42.0</span></code></pre>
    </div>
  </section>

  <!-- SECTION 5: BUILT-IN METRICS -->
  <section id="metrics">
    <span class="section-label">Section 05</span>
    <h2>Built-in Metrics</h2>
    <div class="divider"></div>

    <p>Once the middleware and <code>INSTALLED_APPS</code> entry are in place, you get all of the following without writing a single line of code.</p>

    <h3>HTTP Request Metrics</h3>
    <table class="data-table">
      <thead><tr><th>Metric</th><th>Type</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td>django_http_requests_total_by_method</td><td>Counter</td><td>Request count by HTTP method (GET, POST…)</td></tr>
        <tr><td>django_http_requests_total_by_transport</td><td>Counter</td><td>HTTP vs HTTPS breakdown</td></tr>
        <tr><td>django_http_requests_total_by_view_transport_method</td><td>Counter</td><td>Per view name, transport, and method</td></tr>
        <tr><td>django_http_responses_total_by_status</td><td>Counter</td><td>Response count by HTTP status code</td></tr>
        <tr><td>django_http_responses_total_by_status_view_method</td><td>Counter</td><td>Per status code, view name, and method</td></tr>
        <tr><td>django_http_responses_body_total_bytes</td><td>Counter</td><td>Total bytes sent in response bodies</td></tr>
        <tr><td>django_http_requests_latency_including_middlewares_seconds</td><td>Histogram</td><td>End-to-end request latency (full middleware chain)</td></tr>
        <tr><td>django_http_requests_latency_seconds_by_view_method</td><td>Histogram</td><td>Latency per view name and method</td></tr>
      </tbody>
    </table>

    <h3>Migration Metrics</h3>
    <table class="data-table">
      <thead><tr><th>Metric</th><th>Type</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td>django_migrations_applied_by_connection</td><td>Gauge</td><td>Applied migrations per database alias</td></tr>
        <tr><td>django_migrations_unapplied_by_connection</td><td>Gauge</td><td>Pending (unapplied) migrations — alert on this > 0</td></tr>
      </tbody>
    </table>

    <div class="callout tip">
      <strong>Alert on unapplied migrations</strong>
      <p><code>django_migrations_unapplied_by_connection &gt; 0</code> is one of the most valuable free alerts you get. It catches deployments that forgot to run <code>manage.py migrate</code> before they cause errors.</p>
    </div>

    <h3>Python Runtime Metrics</h3>
    <table class="data-table">
      <thead><tr><th>Metric</th><th>Type</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td>process_virtual_memory_bytes</td><td>Gauge</td><td>Virtual memory size</td></tr>
        <tr><td>process_resident_memory_bytes</td><td>Gauge</td><td>RSS memory (what the OS actually allocated)</td></tr>
        <tr><td>process_cpu_seconds_total</td><td>Counter</td><td>CPU time used</td></tr>
        <tr><td>process_open_fds</td><td>Gauge</td><td>Open file descriptors</td></tr>
        <tr><td>python_gc_objects_collected_total</td><td>Counter</td><td>GC objects collected per generation</td></tr>
        <tr><td>python_info</td><td>Gauge</td><td>Python version info label set</td></tr>
      </tbody>
    </table>
  </section>

  <!-- SECTION 6: DATABASE -->
  <section id="database">
    <span class="section-label">Section 06</span>
    <h2>Database Monitoring</h2>
    <div class="divider"></div>

    <p>By default, Django's database backend does not emit metrics. To enable database monitoring, swap Django's backend with django-prometheus's instrumented version. The only change is the <code>ENGINE</code> value.</p>

    <div class="code-block">
      <div class="code-header"><span>settings/base.py — PostgreSQL</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>DATABASES = {
    <span class="hl3">"default"</span>: {
        <span class="comment-line"># Change: django.db.backends.postgresql</span>
        <span class="comment-line"># To:     django_prometheus.db.backends.postgresql</span>
        <span class="hl3">"ENGINE"</span>: <span class="hl3">"django_prometheus.db.backends.postgresql"</span>,
        <span class="hl3">"NAME"</span>: env(<span class="hl3">"POSTGRES_DB"</span>),
        <span class="hl3">"USER"</span>: env(<span class="hl3">"POSTGRES_USER"</span>),
        <span class="hl3">"PASSWORD"</span>: env(<span class="hl3">"POSTGRES_PASSWORD"</span>),
        <span class="hl3">"HOST"</span>: env(<span class="hl3">"POSTGRES_HOST"</span>, default=<span class="hl3">"localhost"</span>),
        <span class="hl3">"PORT"</span>: env(<span class="hl3">"POSTGRES_PORT"</span>, default=<span class="hl3">"5432"</span>),
        <span class="hl3">"CONN_MAX_AGE"</span>: <span class="m">60</span>,
    }
}

<span class="comment-line"># MySQL:  "django_prometheus.db.backends.mysql"</span>
<span class="comment-line"># SQLite: "django_prometheus.db.backends.sqlite3"</span></code></pre>
    </div>

    <h3>Database Metrics You Get</h3>
    <table class="data-table">
      <thead><tr><th>Metric</th><th>Type</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td>django_db_query_duration_seconds</td><td>Histogram</td><td>Query execution time per alias and vendor</td></tr>
        <tr><td>django_db_execute_total</td><td>Counter</td><td>Total execute() calls</td></tr>
        <tr><td>django_db_execute_many_total</td><td>Counter</td><td>Total executemany() calls</td></tr>
        <tr><td>django_db_errors_total</td><td>Counter</td><td>Database errors by error type</td></tr>
      </tbody>
    </table>
  </section>

  <!-- SECTION 7: CACHE -->
  <section id="cache">
    <span class="section-label">Section 07</span>
    <h2>Cache Monitoring</h2>
    <div class="divider"></div>

    <div class="code-block">
      <div class="code-header"><span>settings/base.py — cache backends</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="comment-line"># Redis cache</span>
CACHES = {
    <span class="hl3">"default"</span>: {
        <span class="comment-line"># Change: django.core.cache.backends.redis.RedisCache</span>
        <span class="comment-line"># To:     django_prometheus.cache.backends.redis.RedisCache</span>
        <span class="hl3">"BACKEND"</span>: <span class="hl3">"django_prometheus.cache.backends.redis.RedisCache"</span>,
        <span class="hl3">"LOCATION"</span>: env(<span class="hl3">"REDIS_URL"</span>),
    }
}

<span class="comment-line"># Memcached</span>
CACHES = {
    <span class="hl3">"default"</span>: {
        <span class="hl3">"BACKEND"</span>: <span class="hl3">"django_prometheus.cache.backends.memcached.PyMemcacheCache"</span>,
        <span class="hl3">"LOCATION"</span>: <span class="hl3">"127.0.0.1:11211"</span>,
    }
}

<span class="comment-line"># File-based (development)</span>
CACHES = {
    <span class="hl3">"default"</span>: {
        <span class="hl3">"BACKEND"</span>: <span class="hl3">"django_prometheus.cache.backends.filebased.FileBasedCache"</span>,
        <span class="hl3">"LOCATION"</span>: <span class="hl3">"/var/tmp/django_cache"</span>,
    }
}</code></pre>
    </div>

    <h3>Cache Metrics You Get</h3>
    <table class="data-table">
      <thead><tr><th>Metric</th><th>Type</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td>django_cache_get_total</td><td>Counter</td><td>Total GET operations</td></tr>
        <tr><td>django_cache_get_hits_total</td><td>Counter</td><td>Cache hits (value was found)</td></tr>
        <tr><td>django_cache_get_misses_total</td><td>Counter</td><td>Cache misses (value not found)</td></tr>
        <tr><td>django_cache_set_total</td><td>Counter</td><td>Total SET operations</td></tr>
        <tr><td>django_cache_delete_total</td><td>Counter</td><td>Total DELETE operations</td></tr>
      </tbody>
    </table>

    <div class="callout tip">
      <strong>Cache hit rate</strong>
      <p>The most important derived cache metric is hit rate: <code>django_cache_get_hits_total / django_cache_get_total</code>. A dropping hit rate means keys are expiring too fast, memory is full, or your code changed and cached keys are no longer being hit.</p>
    </div>
  </section>

  <!-- SECTION 8: MODELS -->
  <section id="models">
    <span class="section-label">Section 08</span>
    <h2>Model Monitoring</h2>
    <div class="divider"></div>

    <p>Track create, update, and delete rates per model by adding a mixin. This requires no database migration — the mixin hooks into Django model signals.</p>

    <div class="code-block">
      <div class="code-header"><span>apps/orders/models.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> django.db <span class="k">import</span> models
<span class="k">from</span> django_prometheus.models <span class="k">import</span> ExportModelOperationsMixin

<span class="comment-line"># The string argument becomes the "model" label value in exported metrics.
# Keep it lowercase, no spaces, short but descriptive.</span>

<span class="k">class</span> <span class="n">Order</span>(ExportModelOperationsMixin(<span class="hl3">"order"</span>), models.Model):
    status = models.CharField(max_length=<span class="m">20</span>)
    total_amount = models.DecimalField(max_digits=<span class="m">10</span>, decimal_places=<span class="m">2</span>)
    created_at = models.DateTimeField(auto_now_add=<span class="k">True</span>)

<span class="k">class</span> <span class="n">OrderItem</span>(ExportModelOperationsMixin(<span class="hl3">"order_item"</span>), models.Model):
    order = models.ForeignKey(Order, on_delete=models.CASCADE)
    quantity = models.PositiveIntegerField()

<span class="k">class</span> <span class="n">Product</span>(ExportModelOperationsMixin(<span class="hl3">"product"</span>), models.Model):
    name = models.CharField(max_length=<span class="m">200</span>)
    stock = models.PositiveIntegerField(default=<span class="m">0</span>)</code></pre>
    </div>

    <p>This exports three metrics per model:</p>

    <div class="code-block">
      <div class="code-header"><span>exported model metrics</span></div>
      <pre><code>django_model_inserts_total{model="order"} 1204.0
django_model_updates_total{model="order"} 982.0
django_model_deletes_total{model="order"} 11.0

django_model_inserts_total{model="order_item"} 3891.0
django_model_updates_total{model="order_item"} 740.0</code></pre>
    </div>

    <div class="callout warning">
      <strong>These are operation counts, not record counts</strong>
      <p>These counters count operations (inserts, updates, deletes) that happened in the current process — not how many records exist in the database. To know how many orders exist, use a Gauge that queries the database (see the Custom Metrics section).</p>
    </div>
  </section>

  <!-- SECTION 9: METRIC TYPES -->
  <section id="types">
    <span class="section-label">Section 09</span>
    <h2>The Four Metric Types</h2>
    <div class="divider"></div>

    <p>Using the wrong metric type leads to incorrect data and misleading dashboards. There are exactly four types. Learn them before writing any custom metrics.</p>

    <div class="metric-grid">
      <div class="metric-card counter">
        <h4>Counter</h4>
        <p>A number that only ever increases. Resets to 0 on process restart. Never decrement a counter.</p>
        <div class="use"><strong>Use for:</strong> events — requests, emails sent, errors raised, jobs completed, payments processed.</div>
        <div class="use" style="margin-top:0.4rem"><strong>Never for:</strong> anything that can go down (queue depth, memory, active connections).</div>
        <div class="use" style="margin-top:0.4rem"><strong>PromQL:</strong> always use <code>rate()</code> or <code>increase()</code>, never the raw value.</div>
      </div>
      <div class="metric-card gauge">
        <h4>Gauge</h4>
        <p>A number that can go up and down. Represents current state.</p>
        <div class="use"><strong>Use for:</strong> active sessions, queue depth, memory usage, open connections, temperature readings.</div>
        <div class="use" style="margin-top:0.4rem"><strong>Never for:</strong> cumulative event counts (use Counter).</div>
        <div class="use" style="margin-top:0.4rem"><strong>PromQL:</strong> raw value is meaningful. Use <code>avg_over_time()</code> for smoothing.</div>
      </div>
      <div class="metric-card histo">
        <h4>Histogram</h4>
        <p>Tracks distribution of values by sorting observations into pre-defined buckets. Exports <code>_bucket</code>, <code>_sum</code>, and <code>_count</code>.</p>
        <div class="use"><strong>Use for:</strong> response latency, request size, queue wait time, payment amounts.</div>
        <div class="use" style="margin-top:0.4rem"><strong>Key decision:</strong> configure bucket boundaries to match your app's expected value range.</div>
        <div class="use" style="margin-top:0.4rem"><strong>PromQL:</strong> <code>histogram_quantile(0.95, rate(metric_bucket[5m]))</code></div>
      </div>
      <div class="metric-card summ">
        <h4>Summary</h4>
        <p>Like Histogram, but pre-computes quantiles client-side. Cannot be aggregated across processes.</p>
        <div class="use"><strong>Use for:</strong> single-process apps where you need precise quantile accuracy.</div>
        <div class="use" style="margin-top:0.4rem"><strong>Avoid for:</strong> multi-process setups (Gunicorn workers). Use Histogram instead.</div>
        <div class="use" style="margin-top:0.4rem"><strong>In practice:</strong> prefer Histogram in virtually all Django production setups.</div>
      </div>
    </div>

    <h3>Counter — Full Code Reference</h3>
    <div class="code-block">
      <div class="code-header"><span>python — Counter</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> prometheus_client <span class="k">import</span> Counter

<span class="comment-line"># Define at MODULE LEVEL — not inside a function or class</span>
orders_created = Counter(
    <span class="hl3">"myapp_orders_created_total"</span>,   <span class="comment-line"># name — counters must end in _total</span>
    <span class="hl3">"Total number of orders created"</span>,
)
payments_failed = Counter(
    <span class="hl3">"myapp_payments_failed_total"</span>,
    <span class="hl3">"Total failed payment attempts"</span>,
    [<span class="hl3">"payment_provider"</span>],           <span class="comment-line"># labels (covered in Section 11)</span>
)

<span class="comment-line"># Usage</span>
orders_created.inc()                                       <span class="comment-line"># +1</span>
orders_created.inc(<span class="m">5</span>)                                    <span class="comment-line"># +5</span>
payments_failed.labels(payment_provider=<span class="hl3">"stripe"</span>).inc()</code></pre>
    </div>

    <h3>Gauge — Full Code Reference</h3>
    <div class="code-block">
      <div class="code-header"><span>python — Gauge</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> prometheus_client <span class="k">import</span> Gauge

active_sessions = Gauge(
    <span class="hl3">"myapp_active_sessions"</span>,
    <span class="hl3">"Number of currently active user sessions"</span>,
)
queue_depth = Gauge(
    <span class="hl3">"myapp_task_queue_depth"</span>,
    <span class="hl3">"Tasks waiting in the Celery queue"</span>,
    [<span class="hl3">"queue_name"</span>],
)

<span class="comment-line"># Usage</span>
active_sessions.set(<span class="m">42</span>)                              <span class="comment-line"># set absolute value</span>
active_sessions.inc()                                  <span class="comment-line"># +1</span>
active_sessions.dec()                                  <span class="comment-line"># -1</span>
queue_depth.labels(queue_name=<span class="hl3">"default"</span>).set(depth)

<span class="comment-line"># Context manager: auto inc on enter, auto dec on exit</span>
<span class="k">with</span> active_sessions.track_inprogress():
    process_request()</code></pre>
    </div>

    <h3>Histogram — Full Code Reference</h3>
    <div class="code-block">
      <div class="code-header"><span>python — Histogram</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> prometheus_client <span class="k">import</span> Histogram

request_latency = Histogram(
    <span class="hl3">"myapp_request_duration_seconds"</span>,
    <span class="hl3">"Time spent processing a request"</span>,
    [<span class="hl3">"endpoint"</span>, <span class="hl3">"method"</span>],
    <span class="comment-line"># Tune buckets for your app's latency profile:</span>
    buckets=(<span class="m">0.005</span>, <span class="m">0.01</span>, <span class="m">0.025</span>, <span class="m">0.05</span>, <span class="m">0.1</span>, <span class="m">0.25</span>, <span class="m">0.5</span>, <span class="m">1.0</span>, <span class="m">2.5</span>, <span class="m">5.0</span>, float(<span class="hl3">"inf"</span>)),
)

payment_amount = Histogram(
    <span class="hl3">"myapp_payment_amount_dollars"</span>,
    <span class="hl3">"Distribution of payment amounts in USD"</span>,
    buckets=(<span class="m">5</span>, <span class="m">10</span>, <span class="m">25</span>, <span class="m">50</span>, <span class="m">100</span>, <span class="m">250</span>, <span class="m">500</span>, <span class="m">1000</span>, float(<span class="hl3">"inf"</span>)),
)

<span class="comment-line"># Usage — manual observe</span>
<span class="k">import</span> time
start = time.time()
process_order()
request_latency.labels(endpoint=<span class="hl3">"/api/orders/"</span>, method=<span class="hl3">"POST"</span>).observe(time.time() - start)

<span class="comment-line"># Usage — context manager (cleaner)</span>
<span class="k">with</span> request_latency.labels(endpoint=<span class="hl3">"/api/orders/"</span>, method=<span class="hl3">"POST"</span>).time():
    process_order()

<span class="comment-line"># Usage — decorator</span>
@request_latency.labels(endpoint=<span class="hl3">"/api/products/"</span>, method=<span class="hl3">"GET"</span>).time()
<span class="k">def</span> <span class="n">list_products</span>():
    ...</code></pre>
    </div>
  </section>

  <!-- SECTION 10: CUSTOM METRICS -->
  <section id="custom">
    <span class="section-label">Section 10</span>
    <h2>Custom Metrics</h2>
    <div class="divider"></div>

    <p>Custom metrics are where django-prometheus becomes truly powerful. The built-in metrics tell you <em>how Django is performing</em>; custom metrics tell you <em>what your business is doing</em>.</p>

    <div class="callout danger">
      <strong>Define metrics at module level</strong>
      <p>Prometheus metrics are global singletons. Define them at the top of a module — never inside a function, view, or class method. Instantiating them inside a function creates duplicate registration errors on every request.</p>
    </div>

    <h3>Create a Dedicated metrics.py File</h3>

    <div class="code-block">
      <div class="code-header"><span>apps/orders/metrics.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="comment-line"># Create one metrics.py per Django app.
# Import from here everywhere you need to record metrics.</span>

<span class="k">from</span> prometheus_client <span class="k">import</span> Counter, Gauge, Histogram

<span class="comment-line"># ── Order metrics ─────────────────────────────────────────────────────────</span>

orders_created = Counter(
    <span class="hl3">"myapp_orders_created_total"</span>,
    <span class="hl3">"Total orders created"</span>,
    [<span class="hl3">"payment_provider"</span>, <span class="hl3">"user_type"</span>],
)

order_processing_duration = Histogram(
    <span class="hl3">"myapp_order_processing_duration_seconds"</span>,
    <span class="hl3">"Time taken to process an order from creation to confirmation"</span>,
    [<span class="hl3">"order_type"</span>],
    buckets=(<span class="m">0.1</span>, <span class="m">0.5</span>, <span class="m">1.0</span>, <span class="m">2.5</span>, <span class="m">5.0</span>, <span class="m">10.0</span>, <span class="m">30.0</span>, <span class="m">60.0</span>, float(<span class="hl3">"inf"</span>)),
)

orders_pending = Gauge(
    <span class="hl3">"myapp_orders_pending"</span>,
    <span class="hl3">"Number of orders currently in pending status"</span>,
)

payments_failed = Counter(
    <span class="hl3">"myapp_payments_failed_total"</span>,
    <span class="hl3">"Total failed payment attempts"</span>,
    [<span class="hl3">"payment_provider"</span>, <span class="hl3">"failure_reason"</span>],
)

<span class="comment-line"># ── User metrics ──────────────────────────────────────────────────────────</span>

user_logins = Counter(
    <span class="hl3">"myapp_user_logins_total"</span>,
    <span class="hl3">"Total successful user logins"</span>,
    [<span class="hl3">"auth_method"</span>],  <span class="comment-line"># password, oauth, sso</span>
)

user_login_failures = Counter(
    <span class="hl3">"myapp_user_login_failures_total"</span>,
    <span class="hl3">"Total failed login attempts"</span>,
    [<span class="hl3">"failure_reason"</span>],  <span class="comment-line"># wrong_password, account_locked, user_not_found</span>
)</code></pre>
    </div>

    <h3>Using Metrics in Your Services</h3>

    <div class="code-block">
      <div class="code-header"><span>apps/orders/services.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> django.db <span class="k">import</span> transaction
<span class="k">from</span> .metrics <span class="k">import</span> orders_created, order_processing_duration, orders_pending, payments_failed

<span class="k">def</span> <span class="n">create_order</span>(*, user, items, payment_provider):
    <span class="k">with</span> order_processing_duration.labels(order_type=<span class="hl3">"standard"</span>).time():
        <span class="k">with</span> transaction.atomic():
            order = Order.objects.create(user=user)
            <span class="k">for</span> item <span class="k">in</span> items:
                OrderItem.objects.create(order=order, **item)

        user_type = <span class="hl3">"premium"</span> <span class="k">if</span> user.is_premium <span class="k">else</span> <span class="hl3">"standard"</span>
        orders_created.labels(payment_provider=payment_provider, user_type=user_type).inc()
        orders_pending.inc()

    <span class="k">return</span> order


<span class="k">def</span> <span class="n">process_payment</span>(order, payment_provider):
    <span class="k">try</span>:
        charge_card(order)
        orders_pending.dec()
    <span class="k">except</span> PaymentDeclined:
        payments_failed.labels(
            payment_provider=payment_provider,
            failure_reason=<span class="hl3">"card_declined"</span>,
        ).inc()
        <span class="k">raise</span>
    <span class="k">except</span> InsufficientFunds:
        payments_failed.labels(
            payment_provider=payment_provider,
            failure_reason=<span class="hl3">"insufficient_funds"</span>,
        ).inc()
        <span class="k">raise</span></code></pre>
    </div>

    <h3>Periodic Gauge Updates via Celery</h3>

    <p>Some gauges represent database counts that need periodic syncing. Use a Celery periodic task:</p>

    <div class="code-block">
      <div class="code-header"><span>apps/orders/tasks.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> celery <span class="k">import</span> shared_task
<span class="k">from</span> .models <span class="k">import</span> Order
<span class="k">from</span> .metrics <span class="k">import</span> orders_pending

@shared_task
<span class="k">def</span> <span class="n">update_order_metrics</span>():
    <span class="hl3">"""Sync gauge with actual DB state. Run every minute via Celery Beat."""</span>
    pending_count = Order.objects.filter(status=<span class="hl3">"pending"</span>).count()
    orders_pending.set(pending_count)</code></pre>
    </div>

    <div class="code-block">
      <div class="code-header"><span>settings/base.py — celery beat schedule</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>CELERY_BEAT_SCHEDULE = {
    <span class="hl3">"update-order-metrics"</span>: {
        <span class="hl3">"task"</span>: <span class="hl3">"apps.orders.tasks.update_order_metrics"</span>,
        <span class="hl3">"schedule"</span>: <span class="m">60.0</span>,  <span class="comment-line"># Every 60 seconds</span>
    },
}</code></pre>
    </div>
  </section>

  <!-- SECTION 11: LABELS -->
  <section id="labels">
    <span class="section-label">Section 11</span>
    <h2>Labels & Cardinality</h2>
    <div class="divider"></div>

    <p>Labels are key-value pairs that let you slice and group data when querying. They are the most powerful feature of Prometheus and the most common source of serious production problems.</p>

    <h3>The High-Cardinality Problem</h3>

    <p>Every unique combination of label values creates a separate <strong>time series</strong> in Prometheus, stored in memory. High-cardinality labels (with many distinct values) cause memory explosions and can bring down your Prometheus instance.</p>

    <div class="two-col">
      <div class="card" style="border-top:2px solid var(--red)">
        <h4 style="color:var(--red)">Never use these as labels</h4>
        <ul>
          <li>User IDs — millions of users = millions of series</li>
          <li>Request IDs / session IDs — unbounded</li>
          <li>IP addresses — unbounded</li>
          <li>Raw URL paths — /api/orders/123, /api/orders/456 creates one series per order</li>
          <li>Timestamps</li>
          <li>Email addresses</li>
        </ul>
      </div>
      <div class="card" style="border-top:2px solid var(--green)">
        <h4 style="color:var(--green)">Good label candidates</h4>
        <ul>
          <li>HTTP method (GET, POST — 5-7 values)</li>
          <li>Status code (200, 404, 500 — small set)</li>
          <li>View name (bounded by code)</li>
          <li>Payment provider (stripe, paypal — small)</li>
          <li>Queue name</li>
          <li>User type (anonymous, authenticated, premium)</li>
          <li>Error type / failure reason</li>
        </ul>
      </div>
    </div>

    <div class="code-block">
      <div class="code-header"><span>python — label do's and don'ts</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="comment-line"># BAD — user_id can be millions of distinct values</span>
request_count = Counter(<span class="hl3">"myapp_requests_total"</span>, <span class="hl3">"Requests"</span>, [<span class="hl3">"user_id"</span>])

<span class="comment-line"># BAD — raw URL path creates one series per unique URL</span>
request_count = Counter(<span class="hl3">"myapp_requests_total"</span>, <span class="hl3">"Requests"</span>, [<span class="hl3">"path"</span>])

<span class="comment-line"># GOOD — view_name is bounded by your codebase size</span>
request_count = Counter(<span class="hl3">"myapp_requests_total"</span>, <span class="hl3">"Requests"</span>, [<span class="hl3">"view_name"</span>])

<span class="comment-line"># GOOD — user_type is a small, bounded set of categories</span>
request_count = Counter(<span class="hl3">"myapp_requests_total"</span>, <span class="hl3">"Requests"</span>, [<span class="hl3">"user_type"</span>])</code></pre>
    </div>

    <div class="callout info">
      <strong>Cardinality rule of thumb</strong>
      <p>Keep each label to under ~100 distinct values. The total time series for a metric equals the product of all label cardinalities: a metric with labels [status (5 values), view_name (50 values), method (5 values)] creates 5 × 50 × 5 = 1,250 time series. That is fine. A metric with a user_id label and 1 million users creates 1 million time series — that will break Prometheus.</p>
    </div>
  </section>

  <!-- SECTION 12: MULTI-PROCESS -->
  <section id="multiproc">
    <span class="section-label">Section 12</span>
    <h2>The Multi-Process Problem</h2>
    <div class="divider"></div>

    <p>This is the most commonly misunderstood aspect of running Prometheus with Python. If you skip this section and run multiple Gunicorn workers, your metrics will be incorrect.</p>

    <h3>Why the Problem Exists</h3>

    <p>The Python Prometheus client stores metric values in memory, inside each Python process. With 4 Gunicorn workers, you have 4 processes with separate metric copies. Prometheus scrapes one worker at random — getting a partial, inconsistent view:</p>

    <div class="arch">
      <div class="arch-title">The problem — inconsistent per-worker metrics</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;align-items:start">
        <div>
          <div class="mp-row" style="margin-bottom:0.5rem">
            <div class="mp-box worker">Worker 1<small>orders_created = 200</small></div>
            <div class="mp-box worker">Worker 2<small>orders_created = 150</small></div>
          </div>
          <div class="mp-row">
            <div class="mp-box worker">Worker 3<small>orders_created = 175</small></div>
            <div class="mp-box worker">Worker 4<small>orders_created = 143</small></div>
          </div>
          <div style="margin-top:1rem;font-size:0.8rem;color:#555;font-family:'JetBrains Mono',monospace">Prometheus scrapes randomly:</div>
          <div style="font-size:0.78rem;color:var(--red);font-family:'JetBrains Mono',monospace;margin-top:0.5rem;line-height:1.8">
            Scrape 1: hits Worker 3 → 175<br>
            Scrape 2: hits Worker 1 → 200<br>
            Scrape 3: hits Worker 2 → 150 ← counter went DOWN?!
          </div>
        </div>
        <div>
          <div class="callout danger" style="margin:0">
            <strong>Result</strong>
            <p>Prometheus sees the counter decrease — which is impossible for a real counter. All graphs are wrong. Rate calculations are garbage. Alerts fire incorrectly.</p>
          </div>
        </div>
      </div>
    </div>

    <h3>The Solution: PROMETHEUS_MULTIPROC_DIR</h3>

    <p>In multiprocess mode, each worker writes its metrics to files in a shared directory. When any worker handles a <code>/metrics</code> request, it reads and aggregates all files from that directory, giving a complete view of all workers.</p>

    <div class="arch">
      <div class="arch-title">Solution — shared directory aggregation</div>
      <div class="mp-diagram">
        <div class="mp-row">
          <div class="mp-box worker">Worker 1<small>writes metrics file</small></div>
          <div class="mp-box worker">Worker 2<small>writes metrics file</small></div>
          <div class="mp-box worker">Worker N<small>writes metrics file</small></div>
        </div>
        <div class="mp-arrow-v"></div>
        <div class="mp-box dir">PROMETHEUS_MULTIPROC_DIR<small>/tmp/prometheus_multiproc/</small></div>
        <div class="mp-arrow-v"></div>
        <div class="mp-label">Any worker handling /metrics reads + aggregates all files</div>
        <div class="mp-arrow-v"></div>
        <div class="mp-box prom">Prometheus<small>sees complete, correct metrics</small></div>
      </div>
    </div>

    <h3>Step-by-Step Setup</h3>

    <div class="steps">
      <div class="step">
        <h3>Create the directory</h3>
        <div class="code-block">
          <div class="code-header"><span>bash</span></div>
          <pre><code>mkdir -p /tmp/prometheus_multiproc

<span class="comment-line"># In production, use a tmpfs for speed:</span>
<span class="comment-line"># /run/prometheus_multiproc  or  /dev/shm/prometheus_multiproc</span></code></pre>
        </div>
      </div>

      <div class="step">
        <h3>Set the environment variable before Django starts</h3>
        <p>This must be set in the <em>shell environment</em>, not from Python code. If set from Python, child processes may not inherit it correctly.</p>
        <div class="code-block">
          <div class="code-header"><span>bash / entrypoint.sh</span></div>
          <pre><code>export PROMETHEUS_MULTIPROC_DIR=/tmp/prometheus_multiproc
gunicorn config.wsgi:application --workers 4</code></pre>
        </div>
        <div class="code-block">
          <div class="code-header"><span>Dockerfile</span></div>
          <pre><code>ENV PROMETHEUS_MULTIPROC_DIR=/tmp/prometheus_multiproc
RUN mkdir -p /tmp/prometheus_multiproc</code></pre>
        </div>
      </div>

      <div class="step">
        <h3>Add child_exit hook to gunicorn.conf.py</h3>
        <p>When a worker exits, its metrics files should be marked dead so they stop being aggregated.</p>
        <div class="code-block">
          <div class="code-header"><span>gunicorn.conf.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
          <pre><code><span class="k">from</span> prometheus_client <span class="k">import</span> multiprocess

<span class="k">def</span> <span class="n">child_exit</span>(server, worker):
    <span class="hl3">"""Called by Gunicorn when a worker exits."""</span>
    multiprocess.mark_process_dead(worker.pid)</code></pre>
        </div>
      </div>

      <div class="step">
        <h3>Clear the directory on startup</h3>
        <p>Stale files from a previous run corrupt your metrics. Always clear before starting.</p>
        <div class="code-block">
          <div class="code-header"><span>entrypoint.sh</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
          <pre><code>#!/bin/bash
set -e

<span class="comment-line"># Clear stale multiprocess files from any previous run</span>
rm -rf /tmp/prometheus_multiproc/*

python manage.py migrate

exec gunicorn config.wsgi:application \
    --workers 4 \
    --config gunicorn.conf.py \
    --bind 0.0.0.0:8000</code></pre>
        </div>
      </div>

      <div class="step">
        <h3>Disable preload_app in Gunicorn</h3>
        <div class="code-block">
          <div class="code-header"><span>gunicorn.conf.py</span></div>
          <pre><code>preload_app = <span class="k">False</span>  <span class="comment-line"># REQUIRED for multiprocess mode</span>
<span class="comment-line"># Gunicorn's --preload loads the app in the master process before forking,
# which breaks multiprocess Prometheus initialization.</span></code></pre>
        </div>
      </div>
    </div>

    <h3>Gauge Modes in Multiprocess</h3>

    <p>Counters and Histograms aggregate naturally (summed). Gauges are trickier — you control aggregation with <code>multiprocess_mode</code>:</p>

    <div class="code-block">
      <div class="code-header"><span>python — multiprocess_mode for Gauges</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> prometheus_client <span class="k">import</span> Gauge

<span class="comment-line"># Sum across all workers — use for quantities each worker tracks independently</span>
active_requests = Gauge(
    <span class="hl3">"myapp_active_requests"</span>,
    <span class="hl3">"Requests currently being processed"</span>,
    multiprocess_mode=<span class="hl3">"livesum"</span>,   <span class="comment-line"># Sum all LIVE workers</span>
)

<span class="comment-line"># Most recent value across all workers — use for config values set once</span>
app_version = Gauge(
    <span class="hl3">"myapp_version_info"</span>,
    <span class="hl3">"Application version"</span>,
    multiprocess_mode=<span class="hl3">"mostrecent"</span>,
)

<span class="comment-line"># Available modes:
# "all"         — one series per process, labeled by pid (default)
# "livesum"     — sum of all LIVE processes only
# "liveall"     — all series, only for LIVE processes
# "min"         — minimum value across all processes
# "max"         — maximum value across all processes
# "sum"         — sum of all processes (alive and dead)
# "mostrecent"  — most recently set value</span></code></pre>
    </div>
  </section>

  <!-- SECTION 13: SECURITY -->
  <section id="security">
    <span class="section-label">Section 13</span>
    <h2>Securing /metrics</h2>
    <div class="divider"></div>

    <p>The <code>/metrics</code> endpoint exposes detailed internal information about your app. In production it must not be publicly accessible.</p>

    <h3>Option 1 — Network-Level Restriction (Recommended)</h3>

    <div class="code-block">
      <div class="code-header"><span>nginx.conf — restrict /metrics by IP</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>server {
    listen 80;
    server_name api.mysite.com;

    <span class="comment-line"># Block /metrics from the public internet</span>
    location /metrics {
        allow <span class="hl3">10.0.1.50</span>;   <span class="comment-line"># Your Prometheus server's internal IP</span>
        deny all;
        proxy_pass http://django:8000;
    }

    location / {
        proxy_pass http://django:8000;
    }
}</code></pre>
    </div>

    <h3>Option 2 — Token Authentication</h3>

    <div class="code-block">
      <div class="code-header"><span>config/urls.py — protected metrics view</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> django.http <span class="k">import</span> HttpResponse
<span class="k">from</span> django.views.decorators.http <span class="k">import</span> require_GET

@require_GET
<span class="k">def</span> <span class="n">metrics_view</span>(request):
    token = request.headers.get(<span class="hl3">"Authorization"</span>, <span class="hl3">""</span>)
    expected = <span class="k">f</span><span class="hl3">"Bearer {settings.PROMETHEUS_TOKEN}"</span>

    <span class="k">if</span> token != expected:
        <span class="k">return</span> HttpResponse(status=<span class="m">403</span>)

    <span class="k">from</span> prometheus_client <span class="k">import</span> generate_latest, CONTENT_TYPE_LATEST
    <span class="k">return</span> HttpResponse(generate_latest(), content_type=CONTENT_TYPE_LATEST)

urlpatterns = [
    path(<span class="hl3">"metrics"</span>, metrics_view, name=<span class="hl3">"prometheus-metrics"</span>),
]</code></pre>
    </div>

    <div class="code-block">
      <div class="code-header"><span>prometheus.yml — send token with scrape</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>scrape_configs:
  - job_name: <span class="hl3">"django"</span>
    authorization:
      credentials: <span class="hl3">"your-secret-token-here"</span>
    static_configs:
      - targets: [<span class="hl3">"api.mysite.com:80"</span>]</code></pre>
    </div>
  </section>

  <!-- SECTION 14: PROMETHEUS SERVER -->
  <section id="prometheus">
    <span class="section-label">Section 14</span>
    <h2>Prometheus Server Configuration</h2>
    <div class="divider"></div>

    <div class="code-block">
      <div class="code-header"><span>provisioning/prometheus/prometheus.yml</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>global:
  scrape_interval: <span class="hl3">15s</span>       <span class="comment-line"># How often Prometheus scrapes targets</span>
  evaluation_interval: <span class="hl3">15s</span>   <span class="comment-line"># How often alerting rules are evaluated</span>

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - <span class="hl3">"alertmanager:9093"</span>

rule_files:
  - <span class="hl3">"alerts.yml"</span>

scrape_configs:
  - job_name: <span class="hl3">"django"</span>
    scrape_interval: <span class="hl3">15s</span>
    static_configs:
      - targets:
          - <span class="hl3">"web:8000"</span>          <span class="comment-line"># Docker service name and port</span>
    metrics_path: <span class="hl3">"/metrics"</span>
    <span class="comment-line"># If you used a URL prefix: metrics_path: "/monitoring/metrics"</span>

  - job_name: <span class="hl3">"prometheus"</span>   <span class="comment-line"># Prometheus monitors itself</span>
    static_configs:
      - targets: [<span class="hl3">"localhost:9090"</span>]</code></pre>
    </div>

    <h3>Kubernetes — ServiceMonitor</h3>

    <div class="code-block">
      <div class="code-header"><span>servicemonitor.yaml</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: django-app
spec:
  selector:
    matchLabels:
      app: django
  endpoints:
    - port: http
      path: /metrics
      interval: 15s</code></pre>
    </div>
  </section>

  <!-- SECTION 15: PROMQL -->
  <section id="promql">
    <span class="section-label">Section 15</span>
    <h2>PromQL Queries</h2>
    <div class="divider"></div>

    <p>PromQL is what you write in Grafana panels and alerting rules. You need to understand these essential functions.</p>

    <h3>rate() — How fast is a counter increasing?</h3>
    <p><code>rate()</code> computes the per-second growth rate of a counter over a time window. Always use <code>rate()</code> on counters — never the raw counter value.</p>

    <div class="promql-box">
      <div class="promql-header"><span>PromQL — rate()</span></div>
      <pre><code><span class="comment-line"># Requests per second (last 5 minutes)</span>
<span class="fn">rate</span>(django_http_requests_total_by_method_total[<span class="num">5m</span>])

<span class="comment-line"># 500 errors per second</span>
<span class="fn">rate</span>(django_http_responses_total_by_status_total{<span class="label-sel">status="500"</span>}[<span class="num">5m</span>])

<span class="comment-line"># DB queries per second</span>
<span class="fn">rate</span>(django_db_execute_total{<span class="label-sel">alias="default"</span>}[<span class="num">5m</span>])</code></pre>
    </div>

    <h3>increase() — How much did a counter grow?</h3>

    <div class="promql-box">
      <div class="promql-header"><span>PromQL — increase()</span></div>
      <pre><code><span class="comment-line"># Total requests in the last 1 hour</span>
<span class="fn">increase</span>(django_http_requests_total_by_method_total[<span class="num">1h</span>])

<span class="comment-line"># Orders created in the last 24 hours</span>
<span class="fn">increase</span>(myapp_orders_created_total[<span class="num">24h</span>])</code></pre>
    </div>

    <h3>sum() and aggregation</h3>

    <div class="promql-box">
      <div class="promql-header"><span>PromQL — sum()</span></div>
      <pre><code><span class="comment-line"># Total requests/s across all methods</span>
<span class="fn">sum</span>(<span class="fn">rate</span>(django_http_requests_total_by_method_total[<span class="num">5m</span>]))

<span class="comment-line"># Requests/s grouped by HTTP method</span>
<span class="fn">sum</span> by (<span class="label-sel">method</span>) (<span class="fn">rate</span>(django_http_requests_total_by_method_total[<span class="num">5m</span>]))

<span class="comment-line"># Total 5xx errors per second</span>
<span class="fn">sum</span>(<span class="fn">rate</span>(django_http_responses_total_by_status_total{<span class="label-sel">status=~"5.."</span>}[<span class="num">5m</span>]))</code></pre>
    </div>

    <h3>histogram_quantile() — Percentile latency</h3>

    <div class="promql-box">
      <div class="promql-header"><span>PromQL — percentiles</span></div>
      <pre><code><span class="comment-line"># p95 request latency (5 minute window)</span>
<span class="fn">histogram_quantile</span>(<span class="num">0.95</span>,
  <span class="fn">rate</span>(django_http_requests_latency_including_middlewares_seconds_bucket[<span class="num">5m</span>])
)

<span class="comment-line"># p99 latency per view</span>
<span class="fn">histogram_quantile</span>(<span class="num">0.99</span>,
  <span class="fn">sum</span> by (<span class="label-sel">view, le</span>) (
    <span class="fn">rate</span>(django_http_requests_latency_seconds_by_view_method_bucket[<span class="num">5m</span>])
  )
)

<span class="comment-line"># Median (p50) latency in milliseconds</span>
<span class="fn">histogram_quantile</span>(<span class="num">0.50</span>,
  <span class="fn">rate</span>(django_http_requests_latency_including_middlewares_seconds_bucket[<span class="num">5m</span>])
) <span class="op">*</span> <span class="num">1000</span></code></pre>
    </div>

    <h3>Production Query Cookbook</h3>

    <div class="promql-box">
      <div class="promql-header"><span>HTTP performance</span></div>
      <pre><code><span class="comment-line"># Overall request rate</span>
<span class="fn">sum</span>(<span class="fn">rate</span>(django_http_requests_total_by_method_total[<span class="num">5m</span>]))

<span class="comment-line"># Error rate — percentage of 5xx responses</span>
<span class="fn">sum</span>(<span class="fn">rate</span>(django_http_responses_total_by_status_total{<span class="label-sel">status=~"5.."</span>}[<span class="num">5m</span>]))
<span class="op">/</span>
<span class="fn">sum</span>(<span class="fn">rate</span>(django_http_requests_total_by_method_total[<span class="num">5m</span>]))
<span class="op">*</span> <span class="num">100</span>

<span class="comment-line"># Apdex score — ratio of requests under 500ms</span>
<span class="fn">sum</span>(<span class="fn">rate</span>(django_http_requests_latency_including_middlewares_seconds_bucket{<span class="label-sel">le="0.5"</span>}[<span class="num">5m</span>]))
<span class="op">/</span>
<span class="fn">sum</span>(<span class="fn">rate</span>(django_http_requests_latency_including_middlewares_seconds_count[<span class="num">5m</span>]))</code></pre>
    </div>

    <div class="promql-box">
      <div class="promql-header"><span>Database & Cache</span></div>
      <pre><code><span class="comment-line"># DB query rate</span>
<span class="fn">rate</span>(django_db_execute_total{<span class="label-sel">alias="default"</span>}[<span class="num">5m</span>])

<span class="comment-line"># Average DB query duration</span>
<span class="fn">rate</span>(django_db_query_duration_seconds_sum[<span class="num">5m</span>])
<span class="op">/</span>
<span class="fn">rate</span>(django_db_query_duration_seconds_count[<span class="num">5m</span>])

<span class="comment-line"># Cache hit rate (0-1, higher is better)</span>
<span class="fn">rate</span>(django_cache_get_hits_total[<span class="num">5m</span>])
<span class="op">/</span>
<span class="fn">rate</span>(django_cache_get_total[<span class="num">5m</span>])</code></pre>
    </div>

    <div class="promql-box">
      <div class="promql-header"><span>Business metrics</span></div>
      <pre><code><span class="comment-line"># Orders created per minute</span>
<span class="fn">sum</span>(<span class="fn">increase</span>(myapp_orders_created_total[<span class="num">1m</span>]))

<span class="comment-line"># Payment failure rate</span>
<span class="fn">rate</span>(myapp_payments_failed_total[<span class="num">5m</span>])
<span class="op">/</span>
(<span class="fn">rate</span>(myapp_payments_failed_total[<span class="num">5m</span>]) <span class="op">+</span> <span class="fn">rate</span>(myapp_orders_created_total[<span class="num">5m</span>]))
<span class="op">*</span> <span class="num">100</span>

<span class="comment-line"># Unapplied migrations — alert when > 0</span>
django_migrations_unapplied_by_connection <span class="op">></span> <span class="num">0</span></code></pre>
    </div>
  </section>

  <!-- SECTION 16: ALERTING -->
  <section id="alerting">
    <span class="section-label">Section 16</span>
    <h2>Alerting Rules</h2>
    <div class="divider"></div>

    <p>Alerting rules are YAML evaluated by Prometheus. When a condition is true for longer than the <code>for:</code> duration, Prometheus fires the alert to Alertmanager, which routes it to Slack, PagerDuty, email, etc.</p>

    <div class="code-block">
      <div class="code-header"><span>provisioning/prometheus/alerts.yml</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>groups:
  - name: django_application
    interval: <span class="hl3">60s</span>

    rules:
      <span class="comment-line"># High error rate — more than 1% of responses are 5xx</span>
      - alert: HighErrorRate
        expr: |
          <span class="k">sum</span>(<span class="k">rate</span>(django_http_responses_total_by_status_total{status=~"5.."}[5m]))
          /
          <span class="k">sum</span>(<span class="k">rate</span>(django_http_requests_total_by_method_total[5m]))
          > 0.01
        for: <span class="hl3">2m</span>   <span class="comment-line"># Must be true for 2 minutes — avoids transient spikes</span>
        labels:
          severity: critical
        annotations:
          summary: <span class="hl3">"High HTTP error rate on {{ $labels.instance }}"</span>
          description: <span class="hl3">"{{ $value | humanizePercentage }} of requests are returning 5xx."</span>

      <span class="comment-line"># p95 latency above 2 seconds</span>
      - alert: HighLatency
        expr: |
          <span class="k">histogram_quantile</span>(0.95,
            <span class="k">rate</span>(django_http_requests_latency_including_middlewares_seconds_bucket[5m])
          ) > 2.0
        for: <span class="hl3">5m</span>
        labels:
          severity: warning
        annotations:
          summary: <span class="hl3">"High request latency"</span>
          description: <span class="hl3">"95th percentile latency is {{ $value }}s"</span>

      <span class="comment-line"># Unapplied migrations — catches missed migration runs after deploy</span>
      - alert: UnappliedMigrations
        expr: django_migrations_unapplied_by_connection > 0
        for: <span class="hl3">1m</span>
        labels:
          severity: warning
        annotations:
          summary: <span class="hl3">"Unapplied database migrations detected"</span>
          description: <span class="hl3">"{{ $value }} migration(s) not applied on {{ $labels.connection }}."</span>

      <span class="comment-line"># DB error spike</span>
      - alert: DatabaseErrors
        expr: rate(django_db_errors_total[5m]) > 0.1
        for: <span class="hl3">1m</span>
        labels:
          severity: critical
        annotations:
          summary: <span class="hl3">"Database errors occurring"</span>
          description: <span class="hl3">"{{ $value }} DB errors per second"</span>

      <span class="comment-line"># Cache hit rate drop</span>
      - alert: LowCacheHitRate
        expr: |
          <span class="k">rate</span>(django_cache_get_hits_total[10m])
          /
          <span class="k">rate</span>(django_cache_get_total[10m])
          < 0.5
        for: <span class="hl3">10m</span>
        labels:
          severity: warning
        annotations:
          summary: <span class="hl3">"Cache hit rate below 50%"</span>
          description: <span class="hl3">"Hit rate is {{ $value | humanizePercentage }}. Check cache config."</span>

      <span class="comment-line"># Payment failure spike (business-critical alert)</span>
      - alert: PaymentFailureSpike
        expr: rate(myapp_payments_failed_total[5m]) > 0.5
        for: <span class="hl3">2m</span>
        labels:
          severity: critical
        annotations:
          summary: <span class="hl3">"Payment failures spiking"</span>
          description: <span class="hl3">"{{ $value }} payment failures per second"</span></code></pre>
    </div>
  </section>

  <!-- SECTION 17: GRAFANA -->
  <section id="grafana">
    <span class="section-label">Section 17</span>
    <h2>Grafana Dashboards</h2>
    <div class="divider"></div>

    <h3>Connect Grafana to Prometheus</h3>
    <p>Open Grafana at <code>http://localhost:3000</code> → <strong>Connections</strong> → <strong>Data Sources</strong> → <strong>Add data source</strong> → <strong>Prometheus</strong>. Set URL to <code>http://prometheus:9090</code>. Click <strong>Save &amp; Test</strong>.</p>

    <h3>Essential Dashboard Panels</h3>

    <table class="data-table">
      <thead><tr><th>Panel</th><th>Visualization</th><th>PromQL Query</th></tr></thead>
      <tbody>
        <tr>
          <td>Request Rate</td>
          <td>Time Series</td>
          <td><code style="font-size:0.75rem">sum(rate(django_http_requests_total_by_method_total[5m]))</code></td>
        </tr>
        <tr>
          <td>Error Rate (%)</td>
          <td>Gauge + Time Series</td>
          <td><code style="font-size:0.75rem">sum(rate(...{status=~"5.."}[5m])) / sum(rate(...[5m])) * 100</code></td>
        </tr>
        <tr>
          <td>p95 Latency (ms)</td>
          <td>Time Series</td>
          <td><code style="font-size:0.75rem">histogram_quantile(0.95, rate(..._bucket[5m])) * 1000</code></td>
        </tr>
        <tr>
          <td>DB Query Rate</td>
          <td>Time Series</td>
          <td><code style="font-size:0.75rem">rate(django_db_execute_total{alias="default"}[5m])</code></td>
        </tr>
        <tr>
          <td>Cache Hit Rate (%)</td>
          <td>Gauge</td>
          <td><code style="font-size:0.75rem">rate(django_cache_get_hits_total[5m]) / rate(django_cache_get_total[5m]) * 100</code></td>
        </tr>
        <tr>
          <td>Memory (MB)</td>
          <td>Time Series</td>
          <td><code style="font-size:0.75rem">process_resident_memory_bytes{job="django"} / 1024 / 1024</code></td>
        </tr>
        <tr>
          <td>Requests by Status</td>
          <td>Time Series (stacked)</td>
          <td><code style="font-size:0.75rem">sum by (status) (rate(django_http_responses_total_by_status_total[5m]))</code></td>
        </tr>
        <tr>
          <td>Unapplied Migrations</td>
          <td>Stat (red threshold at 1)</td>
          <td><code style="font-size:0.75rem">django_migrations_unapplied_by_connection</code></td>
        </tr>
        <tr>
          <td>Pending Orders</td>
          <td>Stat</td>
          <td><code style="font-size:0.75rem">myapp_orders_pending</code></td>
        </tr>
      </tbody>
    </table>

    <div class="callout tip">
      <strong>Pre-built dashboards</strong>
      <p>Search for <em>django prometheus</em> at <code>https://grafana.com/grafana/dashboards/</code> to find community-maintained templates. Import by dashboard ID via Dashboards → Import.</p>
    </div>
  </section>

  <!-- SECTION 18: CUSTOM LABELS -->
  <section id="custom-labels">
    <span class="section-label">Section 18</span>
    <h2>Custom Middleware Labels</h2>
    <div class="divider"></div>

    <p>Attach your own labels to the auto-generated middleware metrics. This lets you slice HTTP metrics by dimensions like <code>api_version</code>, <code>tenant</code>, or <code>user_type</code>.</p>

    <div class="code-block">
      <div class="code-header"><span>myapp/prometheus_middleware.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">from</span> django_prometheus.middleware <span class="k">import</span> (
    Metrics,
    PrometheusBeforeMiddleware,
    PrometheusAfterMiddleware,
)

<span class="k">class</span> <span class="n">CustomMetrics</span>(Metrics):
    <span class="k">def</span> <span class="n">register_metric</span>(self, metric_cls, name, documentation, labelnames=(), **kwargs):
        <span class="comment-line"># Add your label names to every request/response metric</span>
        <span class="k">return</span> super().register_metric(
            metric_cls, name, documentation,
            labelnames=list(labelnames) + [<span class="hl3">"api_version"</span>, <span class="hl3">"user_type"</span>],
            **kwargs,
        )

<span class="k">class</span> <span class="n">CustomPrometheusBeforeMiddleware</span>(PrometheusBeforeMiddleware):
    metrics_cls = CustomMetrics

<span class="k">class</span> <span class="n">CustomPrometheusAfterMiddleware</span>(PrometheusAfterMiddleware):
    metrics_cls = CustomMetrics

    <span class="k">def</span> <span class="n">label_metric</span>(self, metric, request, response=<span class="k">None</span>, **labels):
        <span class="comment-line"># Extract label values from the request</span>
        api_version = getattr(request, <span class="hl3">"version"</span>, <span class="hl3">"v1"</span>) <span class="k">or</span> <span class="hl3">"v1"</span>
        user_type = <span class="hl3">"authenticated"</span> <span class="k">if</span> request.user.is_authenticated <span class="k">else</span> <span class="hl3">"anonymous"</span>

        <span class="k">return</span> super().label_metric(
            metric, request, response,
            api_version=api_version,
            user_type=user_type,
            **labels,
        )</code></pre>
    </div>

    <div class="code-block">
      <div class="code-header"><span>settings/base.py — use custom middleware</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>MIDDLEWARE = [
    <span class="hl3">"myapp.prometheus_middleware.CustomPrometheusBeforeMiddleware"</span>,
    <span class="comment-line"># ... other middlewares ...</span>
    <span class="hl3">"myapp.prometheus_middleware.CustomPrometheusAfterMiddleware"</span>,
]</code></pre>
    </div>
  </section>

  <!-- SECTION 19: DOCKER -->
  <section id="docker">
    <span class="section-label">Section 19</span>
    <h2>Docker & Kubernetes</h2>
    <div class="divider"></div>

    <div class="code-block">
      <div class="code-header"><span>docker-compose.yml — full monitoring stack</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>version: <span class="hl3">"3.9"</span>

x-django-env: &django-env
  DJANGO_SETTINGS_MODULE: config.settings.production
  DATABASE_URL: postgres://user:password@db:5432/mydb
  REDIS_URL: redis://redis:6379/0
  PROMETHEUS_MULTIPROC_DIR: /tmp/prometheus_multiproc

services:
  web:
    build: .
    environment:
      &lt;&lt;: *django-env
    volumes:
      - prometheus_multiproc:/tmp/prometheus_multiproc
    ports:
      - <span class="hl3">"8000:8000"</span>
    depends_on: [db, redis]
    command: >
      sh -c "rm -rf /tmp/prometheus_multiproc/* &&
             python manage.py migrate &&
             gunicorn config.wsgi:application
               --workers 4
               --config gunicorn.conf.py
               --bind 0.0.0.0:8000"

  celery:
    build: .
    environment:
      &lt;&lt;: *django-env
    volumes:
      - prometheus_multiproc:/tmp/prometheus_multiproc
    command: celery -A config worker -l info

  db:
    image: postgres:16
    environment:
      POSTGRES_DB: mydb
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data/

  redis:
    image: redis:7-alpine

  prometheus:
    image: prom/prometheus:latest
    ports:
      - <span class="hl3">"9090:9090"</span>
    volumes:
      - ./provisioning/prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - <span class="hl3">"--config.file=/etc/prometheus/prometheus.yml"</span>
      - <span class="hl3">"--storage.tsdb.retention.time=15d"</span>

  grafana:
    image: grafana/grafana:latest
    ports:
      - <span class="hl3">"3000:3000"</span>
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      GF_SECURITY_ADMIN_PASSWORD: changeme
    depends_on: [prometheus]

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:
  prometheus_multiproc:</code></pre>
    </div>

    <h3>gunicorn.conf.py (complete for multiproc)</h3>

    <div class="code-block">
      <div class="code-header"><span>gunicorn.conf.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="k">import</span> os
<span class="k">from</span> prometheus_client <span class="k">import</span> multiprocess

bind         = os.getenv(<span class="hl3">"BIND"</span>, <span class="hl3">"0.0.0.0:8000"</span>)
workers      = <span class="m">4</span>
worker_class = <span class="hl3">"sync"</span>
preload_app  = <span class="k">False</span>   <span class="comment-line"># REQUIRED for multiprocess Prometheus</span>
timeout      = <span class="m">30</span>
keepalive    = <span class="m">2</span>
accesslog    = <span class="hl3">"-"</span>
errorlog     = <span class="hl3">"-"</span>

<span class="k">def</span> <span class="n">child_exit</span>(server, worker):
    <span class="hl3">"""Clean up prometheus multiprocess files when a worker exits."""</span>
    multiprocess.mark_process_dead(worker.pid)</code></pre>
    </div>

    <h3>Kubernetes Deployment</h3>

    <div class="code-block">
      <div class="code-header"><span>deployment.yaml (relevant sections)</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>spec:
  initContainers:
    <span class="comment-line"># Clear stale multiproc files on pod startup</span>
    - name: clear-prometheus-multiproc
      image: busybox
      command: [<span class="hl3">"sh"</span>, <span class="hl3">"-c"</span>, <span class="hl3">"rm -rf /tmp/prometheus_multiproc/*"</span>]
      volumeMounts:
        - name: prometheus-multiproc
          mountPath: /tmp/prometheus_multiproc

  containers:
    - name: django
      env:
        - name: PROMETHEUS_MULTIPROC_DIR
          value: /tmp/prometheus_multiproc
      volumeMounts:
        - name: prometheus-multiproc
          mountPath: /tmp/prometheus_multiproc

  volumes:
    - name: prometheus-multiproc
      emptyDir:
        medium: Memory   <span class="comment-line"># tmpfs for speed</span></code></pre>
    </div>
  </section>

  <!-- SECTION 20: NAMING -->
  <section id="naming">
    <span class="section-label">Section 20</span>
    <h2>Naming & Best Practices</h2>
    <div class="divider"></div>

    <h3>Metric Naming Conventions</h3>

    <div class="code-block">
      <div class="code-header"><span>naming rules</span></div>
      <pre><code><span class="comment-line"># Pattern:
# &lt;namespace&gt;_&lt;subsystem&gt;_&lt;name&gt;_&lt;unit&gt;_total  (counters)
# &lt;namespace&gt;_&lt;subsystem&gt;_&lt;name&gt;_&lt;unit&gt;         (gauges, histograms)</span>

<span class="comment-line"># Good names</span>
<span class="hl3">"myapp_http_requests_total"</span>
<span class="hl3">"myapp_order_processing_duration_seconds"</span>
<span class="hl3">"myapp_cache_size_bytes"</span>
<span class="hl3">"myapp_active_connections"</span>
<span class="hl3">"myapp_payment_amount_dollars"</span>

<span class="comment-line"># Bad names — and why</span>
<span class="hl3">"myapp_requests"</span>           <span class="comment-line"># Counter missing _total</span>
<span class="hl3">"myapp_requestDurationMs"</span>  <span class="comment-line"># Camel case, non-base unit (use seconds)</span>
<span class="hl3">"myapp_metric_count"</span>       <span class="comment-line"># "metric" in name is redundant</span>
<span class="hl3">"myapp_http_by_user"</span>       <span class="comment-line"># Label value in name — use a label instead</span></code></pre>
    </div>

    <h3>RED & USE Methods</h3>

    <div class="method-grid">
      <div class="method-card red">
        <h4>RED Method</h4>
        <p style="font-size:0.82rem;color:#888;margin-bottom:0.75rem">For every service endpoint and background task:</p>
        <ul>
          <li><strong>R</strong>ate — How many requests/second?</li>
          <li><strong>E</strong>rrors — What fraction are failing?</li>
          <li><strong>D</strong>uration — How long does each take?</li>
        </ul>
      </div>
      <div class="method-card use">
        <h4>USE Method</h4>
        <p style="font-size:0.82rem;color:#888;margin-bottom:0.75rem">For every resource (DB, cache, queue, workers):</p>
        <ul>
          <li><strong>U</strong>tilization — What fraction of capacity is used?</li>
          <li><strong>S</strong>aturation — How much is queued waiting?</li>
          <li><strong>E</strong>rrors — Are errors occurring?</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- SECTION 21: CHECKLIST -->
  <section id="checklist">
    <span class="section-label">Section 21</span>
    <h2>Production Checklist</h2>
    <div class="divider"></div>

    <div class="checklist-group">
      <h4>Initial Setup</h4>
      <ul class="checklist">
        <li><code>django_prometheus</code> is in INSTALLED_APPS</li>
        <li><code>PrometheusBeforeMiddleware</code> is the very first middleware</li>
        <li><code>PrometheusAfterMiddleware</code> is the very last middleware</li>
        <li><code>django_prometheus.urls</code> is included in urls.py</li>
        <li>The /metrics endpoint returns data when visited locally</li>
        <li><code>PROMETHEUS_METRIC_NAMESPACE</code> is set to your project name</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Database, Cache & Models</h4>
      <ul class="checklist">
        <li>Database ENGINE is <code>django_prometheus.db.backends.postgresql</code> (or mysql/sqlite3)</li>
        <li>Cache BACKEND is the django_prometheus equivalent</li>
        <li><code>ExportModelOperationsMixin</code> is added to all key models</li>
        <li>Mixin label strings are lowercase, concise, and unique per model</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Multi-Process (Gunicorn)</h4>
      <ul class="checklist">
        <li><code>PROMETHEUS_MULTIPROC_DIR</code> is set in the environment (not Python code)</li>
        <li>The directory is created before startup</li>
        <li>The directory is cleared before every startup (especially in Docker)</li>
        <li>gunicorn.conf.py has the <code>child_exit</code> hook calling <code>multiprocess.mark_process_dead</code></li>
        <li><code>preload_app = False</code> in gunicorn.conf.py</li>
        <li>Gauges use the appropriate <code>multiprocess_mode</code> (livesum, liveall, etc.)</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Custom Metrics</h4>
      <ul class="checklist">
        <li>All custom metrics are defined at module level in metrics.py files</li>
        <li>Counter names end in <code>_total</code></li>
        <li>Metric names are lowercase with underscores and include unit</li>
        <li>No high-cardinality labels (no user IDs, request IDs, raw URLs)</li>
        <li>Each endpoint/task has Rate, Error, Duration metrics (RED method)</li>
        <li>Key resources have Utilization, Saturation, Error metrics (USE method)</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Security</h4>
      <ul class="checklist">
        <li>/metrics is not publicly accessible in production</li>
        <li>Either nginx restricts access by IP, or token auth is implemented</li>
        <li>The metrics endpoint is not in public documentation or robots.txt</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Prometheus Server</h4>
      <ul class="checklist">
        <li>prometheus.yml has correct targets pointing to your Django app</li>
        <li><code>metrics_path</code> set if you used a URL prefix other than root</li>
        <li>Storage retention configured (<code>--storage.tsdb.retention.time</code>)</li>
        <li>Alerting rules file included and loaded</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Alerting</h4>
      <ul class="checklist">
        <li>Alert fires when 5xx error rate exceeds threshold</li>
        <li>Alert fires when p95 latency exceeds threshold</li>
        <li>Alert fires when <code>django_migrations_unapplied_by_connection &gt; 0</code></li>
        <li>Alert fires when DB error rate spikes</li>
        <li>Alert fires when cache hit rate drops below threshold</li>
        <li>Alerts have meaningful summary and description annotations</li>
        <li>Alerts have <code>for:</code> duration set to avoid transient false positives</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Grafana</h4>
      <ul class="checklist">
        <li>Prometheus is added as data source and verified with "Save &amp; Test"</li>
        <li>Dashboard has: request rate, error rate, p95 latency, DB query rate, cache hit rate</li>
        <li>Business metric panels for key models and workflows</li>
        <li>Memory and CPU panels exist</li>
        <li>Unapplied migrations stat panel with red threshold at 1</li>
      </ul>
    </div>
  </section>

</div>

<footer>
  Ultimate Django Deployment Guides — Guide #2 of 6 — django-prometheus<br>
  <span style="opacity:0.5;font-size:0.75rem">github.com/django-commons/django-prometheus · prometheus.io/docs · github.com/prometheus/client_python</span>
</footer>

<script>
function copyCode(btn) {
  const pre = btn.closest('.code-block').querySelector('pre');
  navigator.clipboard.writeText(pre.innerText).then(() => {
    const orig = btn.textContent;
    btn.textContent = 'Copied!';
    btn.style.color = 'var(--green)';
    btn.style.borderColor = 'var(--green)';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; btn.style.borderColor = ''; }, 2000);
  });
}
</script>
</body>
</html>
