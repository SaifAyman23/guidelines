<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Ultimate Guide: pytest & pytest-django</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=JetBrains+Mono:wght@300;400;500;700&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:           #0a0f1e;
    --surface:      #0f1629;
    --surface2:     #141c35;
    --surface3:     #1a2340;
    --border:       #1e2d50;
    --border-strong:#2a3f6e;
    --text:         #e8ecf8;
    --muted:        #7a8ab8;
    --muted2:       #4a5a88;
    --yellow:       #f5c400;
    --yellow-bright:#ffd700;
    --yellow-pale:  #fffbe6;
    --yellow-dim:   rgba(245,196,0,0.12);
    --yellow-glow:  rgba(245,196,0,0.25);
    --blue:         #3b82f6;
    --blue-light:   #dbeafe;
    --blue-dim:     rgba(59,130,246,0.12);
    --green:        #10b981;
    --green-light:  #d1fae5;
    --green-dim:    rgba(16,185,129,0.12);
    --red:          #f43f5e;
    --red-light:    #ffe4e6;
    --red-dim:      rgba(244,63,94,0.12);
    --amber:        #f59e0b;
    --amber-light:  #fef3c7;
    --purple:       #a78bfa;
    --purple-dim:   rgba(167,139,250,0.12);
    --navy-deep:    #060b17;
    --ink:          #ffffff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Lora', Georgia, serif;
    font-size: 16px;
    line-height: 1.8;
  }

  /* ── NAV ── */
  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(6,11,23,0.97);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    display: flex; align-items: center; gap: 0;
    height: 52px; overflow-x: auto;
  }
  nav::-webkit-scrollbar { display: none; }

  nav .logo {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
    flex-shrink: 0;
    margin-right: 2rem;
    letter-spacing: 0.05em;
  }
  nav .logo span { color: var(--yellow); }

  nav a {
    color: var(--muted2);
    text-decoration: none;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    white-space: nowrap;
    padding: 0 0.8rem;
    height: 52px;
    display: flex; align-items: center;
    border-bottom: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s;
  }
  nav a:hover { color: var(--yellow); border-bottom-color: var(--yellow); }

  /* ── HERO ── */
  .hero {
    background: var(--navy-deep);
    color: var(--text);
    padding: 6rem 2rem 5rem;
    text-align: center;
    position: relative;
    overflow: hidden;
    border-bottom: 1px solid var(--border);
  }

  .hero::before {
    content: '';
    position: absolute;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 60% at 50% 100%, rgba(245,196,0,0.08) 0%, transparent 70%),
      radial-gradient(ellipse at 15% 50%, rgba(59,130,246,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 85% 50%, rgba(59,130,246,0.06) 0%, transparent 50%),
      repeating-linear-gradient(90deg, transparent, transparent 79px, rgba(245,196,0,0.025) 79px, rgba(245,196,0,0.025) 80px),
      repeating-linear-gradient(0deg, transparent, transparent 79px, rgba(245,196,0,0.025) 79px, rgba(245,196,0,0.025) 80px);
    pointer-events: none;
  }

  .hero::after {
    content: '';
    position: absolute;
    bottom: 0; left: 50%; transform: translateX(-50%);
    width: 600px; height: 1px;
    background: linear-gradient(90deg, transparent, var(--yellow), transparent);
    opacity: 0.4;
  }

  .hero-eyebrow {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--yellow);
    margin-bottom: 2rem;
    position: relative;
    display: flex; align-items: center; justify-content: center; gap: 1.5rem;
  }
  .hero-eyebrow::before, .hero-eyebrow::after {
    content: '';
    width: 40px; height: 1px;
    background: var(--yellow);
    opacity: 0.5;
  }

  .hero h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(3rem, 7vw, 5.5rem);
    font-weight: 900;
    line-height: 1.05;
    letter-spacing: -0.02em;
    margin-bottom: 1.5rem;
    position: relative;
    color: var(--ink);
  }

  .hero h1 em {
    font-style: italic;
    color: var(--yellow);
    font-weight: 700;
  }

  .hero h1 .sub {
    display: block;
    font-size: 0.4em;
    letter-spacing: 0.15em;
    font-style: normal;
    font-weight: 400;
    color: var(--muted);
    text-transform: uppercase;
    font-family: 'JetBrains Mono', monospace;
    margin-top: 0.8rem;
  }

  .hero p {
    font-size: 1rem;
    color: var(--muted);
    max-width: 540px;
    margin: 0 auto 3rem;
    line-height: 1.9;
    position: relative;
    font-style: italic;
    font-weight: 400;
  }

  .hero-badges {
    display: flex; align-items: center; justify-content: center;
    gap: 0.6rem; flex-wrap: wrap; position: relative;
  }
  .hero-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.62rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.3rem 0.8rem;
    border-radius: 2px;
    border: 1px solid var(--border-strong);
    color: var(--muted);
    text-decoration: none;
    transition: all 0.2s;
  }
  .hero-badge:hover {
    border-color: var(--yellow);
    color: var(--yellow);
    background: var(--yellow-dim);
  }
  .hero-badge.primary {
    border-color: var(--yellow);
    color: var(--yellow);
    background: var(--yellow-dim);
  }

  /* ── CONTENT ── */
  .content { max-width: 860px; margin: 0 auto; padding: 0 2rem 8rem; }

  section {
    margin-bottom: 5.5rem;
    scroll-margin-top: 70px;
    padding-top: 3rem;
    border-top: 1px solid var(--border);
  }
  section:first-of-type { border-top: none; }

  /* ── HEADINGS ── */
  h2 {
    font-family: 'Playfair Display', serif;
    font-size: 2.2rem;
    font-weight: 700;
    line-height: 1.15;
    margin-bottom: 0.5rem;
    color: var(--ink);
    letter-spacing: -0.01em;
  }

  h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 0.8rem;
    color: var(--text);
    font-style: italic;
  }

  .section-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    font-weight: 500;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--yellow);
    margin-bottom: 0.6rem;
    display: flex; align-items: center; gap: 0.75rem;
  }
  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--yellow), transparent);
    opacity: 0.3;
    max-width: 120px;
  }

  .divider {
    width: 32px;
    height: 3px;
    background: var(--yellow);
    margin: 0.8rem 0 2rem;
  }

  p { margin-bottom: 1.3rem; color: #b8c4e0; }
  strong { color: var(--text); font-weight: 500; }

  /* ── CODE ── */
  .code-block {
    background: var(--navy-deep);
    border-radius: 4px;
    overflow: hidden;
    margin: 1.5rem 0;
    font-size: 0.83rem;
    border: 1px solid var(--border);
    position: relative;
  }
  .code-block::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--yellow), transparent);
    opacity: 0.5;
  }

  .code-header {
    background: rgba(0,0,0,0.4);
    border-bottom: 1px solid var(--border);
    padding: 0.5rem 1.2rem;
    display: flex; justify-content: space-between; align-items: center;
  }

  .code-header span {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    color: var(--muted2);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .copy-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted2);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.58rem;
    padding: 0.18rem 0.55rem;
    border-radius: 2px;
    cursor: pointer;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: all 0.2s;
  }
  .copy-btn:hover { color: var(--yellow); border-color: var(--yellow); }

  pre {
    padding: 1.4rem 1.2rem;
    overflow-x: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    line-height: 1.9;
    color: #c8d4f0;
    tab-size: 4;
  }

  code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.82em;
    background: rgba(245,196,0,0.1);
    padding: 0.1em 0.4em;
    border-radius: 2px;
    color: var(--yellow-bright);
    border: 1px solid rgba(245,196,0,0.2);
  }
  pre code { background: none; padding: 0; color: #c8d4f0; font-size: 1em; border: none; }

  /* syntax */
  .kw  { color: #7dd3fc; }
  .st  { color: #86efac; }
  .cm  { color: #334466; font-style: italic; }
  .fn  { color: #fbbf24; }
  .nm  { color: #c084fc; }
  .hl  { color: var(--yellow); }
  .hl2 { color: #34d399; }
  .num { color: #fb923c; }
  .dec { color: #f472b6; }

  /* ── CALLOUTS ── */
  .callout {
    border-radius: 3px;
    padding: 1rem 1.3rem;
    margin: 1.5rem 0;
    border-left: 3px solid;
    font-size: 0.91rem;
  }
  .callout.info    { background: var(--blue-dim);   border-color: var(--blue);   }
  .callout.warning { background: rgba(245,158,11,0.1); border-color: var(--amber); }
  .callout.tip     { background: var(--green-dim);  border-color: var(--green);  }
  .callout.danger  { background: var(--red-dim);    border-color: var(--red);    }
  .callout.note    { background: var(--yellow-dim); border-color: var(--yellow); }
  .callout.purple  { background: var(--purple-dim); border-color: var(--purple); }

  .callout strong {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    display: block;
    margin-bottom: 0.35rem;
    font-weight: 700;
  }
  .callout.info    strong { color: var(--blue);   }
  .callout.warning strong { color: var(--amber);  }
  .callout.tip     strong { color: var(--green);  }
  .callout.danger  strong { color: var(--red);    }
  .callout.note    strong { color: var(--yellow); }
  .callout.purple  strong { color: var(--purple); }
  .callout p { margin: 0; color: #8898cc; font-size: 0.88rem; line-height: 1.7; }

  /* ── TABLES ── */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
  }
  .data-table th {
    background: rgba(245,196,0,0.08);
    border-bottom: 1px solid rgba(245,196,0,0.2);
    color: var(--yellow);
    padding: 0.65rem 1rem;
    text-align: left;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.62rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }
  .data-table td {
    padding: 0.65rem 1rem;
    border-bottom: 1px solid var(--border);
    color: #8898cc;
    font-size: 0.86rem;
    vertical-align: top;
  }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table td:first-child {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.74rem;
    color: var(--yellow-bright);
    white-space: nowrap;
  }
  .data-table tr:hover td { background: rgba(245,196,0,0.03); }

  /* ── TWO COL ── */
  .two-col {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;
  }
  @media (max-width: 640px) { .two-col { grid-template-columns: 1fr; } }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.4rem;
    border-top: 3px solid var(--yellow);
    position: relative;
    overflow: hidden;
  }
  .card::after {
    content: '';
    position: absolute;
    bottom: 0; right: 0;
    width: 60px; height: 60px;
    background: radial-gradient(circle at bottom right, rgba(245,196,0,0.06), transparent);
    pointer-events: none;
  }
  .card h4 {
    margin-top: 0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--yellow);
    margin-bottom: 0.8rem;
    padding-bottom: 0.6rem;
    border-bottom: 1px solid var(--border);
  }
  .card ul { list-style: none; }
  .card ul li {
    padding: 0.3rem 0;
    font-size: 0.86rem;
    color: #8898cc;
    display: flex; gap: 0.65rem; align-items: flex-start;
  }
  .card ul li::before { content: '▸'; color: var(--yellow); font-size: 0.7rem; flex-shrink: 0; margin-top: 0.25rem; font-family: 'JetBrains Mono', monospace; }
  .card p { font-size: 0.83rem; color: #556688; font-style: italic; margin-top: 0.8rem; margin-bottom: 0; }

  /* ── TOC ── */
  .toc {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2.2rem;
    margin: 3rem 0 4.5rem;
    position: relative;
    overflow: hidden;
  }
  .toc::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--yellow), rgba(245,196,0,0.2));
  }
  .toc::after {
    content: 'INDEX';
    position: absolute;
    top: 2rem; right: 2rem;
    font-family: 'Playfair Display', serif;
    font-size: 5rem;
    font-weight: 900;
    color: rgba(245,196,0,0.04);
    line-height: 1;
    letter-spacing: -0.02em;
    pointer-events: none;
  }
  .toc h3 {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 700;
    font-size: 0.65rem;
    letter-spacing: 0.22em;
    text-transform: uppercase;
    margin-top: 0;
    margin-bottom: 1.5rem;
    color: var(--yellow);
    font-style: normal;
    display: flex; align-items: center; gap: 0.8rem;
  }
  .toc h3::after {
    content: '';
    flex: 1; height: 1px;
    background: linear-gradient(90deg, rgba(245,196,0,0.3), transparent);
  }
  .toc ol { padding-left: 1.5rem; columns: 2; column-gap: 3rem; }
  @media (max-width: 640px) { .toc ol { columns: 1; } }
  .toc ol li { margin-bottom: 0.42rem; break-inside: avoid; }
  .toc ol li::marker {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted2);
  }
  .toc a {
    color: #7a8ab8;
    text-decoration: none;
    font-family: 'Lora', serif;
    font-size: 0.88rem;
    transition: color 0.2s;
  }
  .toc a:hover { color: var(--yellow); }

  /* ── STEPS ── */
  .steps { counter-reset: step; }
  .step {
    position: relative; padding-left: 4rem;
    margin-bottom: 2.8rem; counter-increment: step;
  }
  .step::before {
    content: counter(step);
    position: absolute; left: 0; top: 0.05rem;
    width: 2.4rem; height: 2.4rem;
    background: transparent;
    border: 2px solid var(--yellow);
    color: var(--yellow);
    font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700;
    border-radius: 2px;
    display: flex; align-items: center; justify-content: center;
  }
  .step h3 { margin-top: 0.1rem; }

  /* ── PITFALL ── */
  .pitfall {
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin: 1.5rem 0;
    border-left: 4px solid var(--red);
  }
  .pitfall-problem {
    background: var(--red-dim);
    border-bottom: 1px solid rgba(244,63,94,0.2);
    padding: 0.75rem 1.2rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    font-weight: 700;
    color: #fb7185;
    letter-spacing: 0.04em;
  }
  .pitfall-body { background: var(--surface); padding: 1rem 1.2rem; }
  .pitfall-body p { font-size: 0.87rem; margin-bottom: 0.5rem; color: #8898cc; }
  .pitfall-body p:last-child { margin-bottom: 0; }
  .pitfall-body .cause {
    font-family: 'JetBrains Mono', monospace; font-size: 0.68rem;
    color: var(--muted2); font-style: italic; display: block; margin-bottom: 0.5rem;
  }

  /* ── CHECKLIST ── */
  .checklist-group {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.3rem 1.5rem;
    margin: 0.9rem 0;
    border-left: 3px solid var(--yellow);
    position: relative;
  }
  .checklist-group h4 {
    font-family: 'JetBrains Mono', monospace; font-size: 0.62rem;
    color: var(--yellow); text-transform: uppercase;
    letter-spacing: 0.16em; margin-bottom: 0.8rem; margin-top: 0; font-weight: 700;
  }
  .checklist { list-style: none; }
  .checklist li {
    padding: 0.44rem 0; border-bottom: 1px solid var(--border);
    font-size: 0.87rem; color: #8898cc; display: flex; gap: 0.75rem; align-items: flex-start;
  }
  .checklist li:last-child { border-bottom: none; }
  .checklist li::before {
    content: '□';
    font-size: 0.9rem; color: var(--border-strong); flex-shrink: 0; margin-top: 0.1rem;
    font-family: 'JetBrains Mono', monospace;
  }

  /* ── COMMAND GRID ── */
  .cmd-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin: 1.5rem 0;
  }
  @media (max-width: 600px) { .cmd-grid { grid-template-columns: 1fr; } }

  .cmd-item {
    background: var(--navy-deep);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 0.75rem 1rem;
    display: flex; flex-direction: column; gap: 0.3rem;
  }
  .cmd-item code {
    font-size: 0.76rem;
    background: none;
    border: none;
    color: var(--yellow-bright);
    padding: 0;
  }
  .cmd-item span {
    font-size: 0.75rem;
    color: var(--muted2);
    font-family: 'JetBrains Mono', monospace;
  }

  /* ── FOOTER ── */
  footer {
    background: var(--navy-deep);
    border-top: 1px solid var(--border);
    color: var(--muted2);
    padding: 2.5rem;
    text-align: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.68rem;
    letter-spacing: 0.06em;
  }
  footer a { color: var(--muted); text-decoration: none; transition: color 0.2s; }
  footer a:hover { color: var(--yellow); }
  footer .sep { margin: 0 1rem; color: var(--border-strong); }

  /* ── INLINE TAG ── */
  .tag {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.62rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.15rem 0.45rem;
    border-radius: 2px;
    vertical-align: middle;
    margin: 0 0.1rem;
  }
  .tag.yellow { background: var(--yellow-dim); color: var(--yellow); border: 1px solid rgba(245,196,0,0.25); }
  .tag.blue   { background: var(--blue-dim);   color: var(--blue);   border: 1px solid rgba(59,130,246,0.25); }
  .tag.green  { background: var(--green-dim);  color: var(--green);  border: 1px solid rgba(16,185,129,0.25); }

  @media (max-width: 640px) {
    h2 { font-size: 1.75rem; }
    .hero h1 { font-size: 2.8rem; }
    .hero { padding: 3.5rem 1.5rem 3rem; }
    .content { padding: 0 1.25rem 6rem; }
    .toc::after { display: none; }
  }

  /* ── SCROLL ANIMATION ── */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  section { animation: fadeUp 0.5s ease both; }
</style>
</head>
<body>

<nav>
  <span class="logo">pytest-<span>django</span></span>
  <a href="#why">Why pytest</a>
  <a href="#mental">Mental Model</a>
  <a href="#install">Install</a>
  <a href="#config">Config</a>
  <a href="#first">First Test</a>
  <a href="#fixtures">Fixtures</a>
  <a href="#djfixtures">Django Fixtures</a>
  <a href="#database">Database</a>
  <a href="#models">Models</a>
  <a href="#views">Views</a>
  <a href="#forms">Forms</a>
  <a href="#drf">DRF APIs</a>
  <a href="#parametrize">Parametrize</a>
  <a href="#factories">Factories</a>
  <a href="#mocking">Mocking</a>
  <a href="#signals">Signals</a>
  <a href="#celery">Celery</a>
  <a href="#email">Email</a>
  <a href="#files">Files</a>
  <a href="#commands">Commands</a>
  <a href="#auth">Auth</a>
  <a href="#markers">Markers</a>
  <a href="#coverage">Coverage</a>
  <a href="#perf">Performance</a>
  <a href="#ci">CI</a>
  <a href="#layout">Layout</a>
  <a href="#pitfalls">Pitfalls</a>
  <a href="#checklist">Checklist</a>
</nav>

<div class="hero">
  <div class="hero-eyebrow">Ultimate Guide</div>
  <h1>pytest &amp; <em>pytest-django</em><span class="sub">The Complete Reference</span></h1>
  <p>Everything you need to write fast, reliable, and maintainable tests for Django — from your first assertion to factories, mocking, parametrize, coverage, and CI integration.</p>
  <div class="hero-badges">
    <span class="hero-badge primary">pytest 8.x</span>
    <span class="hero-badge primary">pytest-django 4.x</span>
    <a class="hero-badge" href="https://docs.pytest.org/" target="_blank">docs.pytest.org</a>
    <a class="hero-badge" href="https://pytest-django.readthedocs.io/" target="_blank">pytest-django docs</a>
    <a class="hero-badge" href="https://factoryboy.readthedocs.io/" target="_blank">factory_boy</a>
  </div>
</div>

<div class="content">

  <div class="toc">
    <h3>Table of Contents</h3>
    <ol>
      <li><a href="#why">Why pytest Instead of unittest</a></li>
      <li><a href="#mental">How pytest Works — The Mental Model</a></li>
      <li><a href="#install">Installation</a></li>
      <li><a href="#config">Configuration — pyproject.toml / pytest.ini</a></li>
      <li><a href="#first">Your First Django Test</a></li>
      <li><a href="#fixtures">Fixtures — The Core of pytest</a></li>
      <li><a href="#djfixtures">Django-Specific Fixtures</a></li>
      <li><a href="#database">The Database and Transactions</a></li>
      <li><a href="#models">Testing Models</a></li>
      <li><a href="#views">Testing Views and URLs</a></li>
      <li><a href="#forms">Testing Forms</a></li>
      <li><a href="#drf">Testing Django REST Framework APIs</a></li>
      <li><a href="#parametrize">Parametrize — One Test, Many Inputs</a></li>
      <li><a href="#factories">Factories with factory_boy</a></li>
      <li><a href="#mocking">Mocking — unittest.mock and pytest-mock</a></li>
      <li><a href="#signals">Testing Signals</a></li>
      <li><a href="#celery">Testing Celery Tasks</a></li>
      <li><a href="#email">Testing Email</a></li>
      <li><a href="#files">Testing File Uploads</a></li>
      <li><a href="#commands">Testing Management Commands</a></li>
      <li><a href="#auth">Testing Authentication and Permissions</a></li>
      <li><a href="#markers">Markers — Categorizing Tests</a></li>
      <li><a href="#coverage">Coverage with pytest-cov</a></li>
      <li><a href="#perf">Performance — Speeding Up Your Suite</a></li>
      <li><a href="#ci">Running Tests in CI</a></li>
      <li><a href="#layout">Project Layout and Organization</a></li>
      <li><a href="#pitfalls">Common Pitfalls &amp; Troubleshooting</a></li>
      <li><a href="#checklist">Checklist</a></li>
    </ol>
  </div>

  <!-- S1 -->
  <section id="why">
    <span class="section-label">Section 01</span>
    <h2>Why pytest Instead of unittest</h2>
    <div class="divider"></div>
    <p>Django ships with its own test runner built on top of Python's <code>unittest</code>. It works, but pytest is almost universally preferred in the Django community. Here is why.</p>
    <p><strong>Less boilerplate.</strong> With <code>unittest</code>, every test class inherits from <code>TestCase</code>. With pytest, a test is just a function that starts with <code>test_</code>. Nothing to inherit.</p>
    <div class="code-block">
      <div class="code-header"><span>comparison</span></div>
      <pre><code><span class="cm"># unittest style — verbose</span>
<span class="kw">import</span> unittest
<span class="kw">from</span> django.test <span class="kw">import</span> TestCase

<span class="kw">class</span> <span class="fn">ArticleModelTest</span>(TestCase):
    <span class="kw">def</span> <span class="fn">test_str_representation</span>(self):
        article = Article(title=<span class="st">'Hello'</span>)
        self.assertEqual(str(article), <span class="st">'Hello'</span>)

<span class="cm"># pytest style — clean</span>
<span class="kw">def</span> <span class="fn">test_article_str_representation</span>():
    article = Article(title=<span class="st">'Hello'</span>)
    <span class="kw">assert</span> str(article) == <span class="st">'Hello'</span></code></pre>
    </div>
    <p><strong>Better assertion messages.</strong> When a pytest assertion fails, pytest rewrites the expression and shows you exactly what the left and right sides evaluated to. No more generic <code>AssertionError</code>.</p>
    <div class="two-col">
      <div class="card">
        <h4>What pytest gives you</h4>
        <ul>
          <li>Plain functions — no class inheritance required</li>
          <li>Introspective assertion rewrites with diff output</li>
          <li>Composable, scoped fixtures replace setUp/tearDown</li>
          <li>Parametrize: run one test with many inputs</li>
          <li>Rich plugin ecosystem (cov, mock, xdist, factoryboy)</li>
          <li>Full compatibility with Django's TestCase</li>
        </ul>
      </div>
      <div class="card">
        <h4>Migration is painless</h4>
        <ul>
          <li>Existing django.test.TestCase tests run unmodified</li>
          <li>Adopt pytest incrementally — one file at a time</li>
          <li>No rewrites required on day one</li>
          <li>pytest collects both styles automatically</li>
        </ul>
        <p>You do not have to rewrite existing tests. pytest-django is fully compatible with Django's TestCase.</p>
      </div>
    </div>
  </section>

  <!-- S2 -->
  <section id="mental">
    <span class="section-label">Section 02</span>
    <h2>How pytest Works — The Mental Model</h2>
    <div class="divider"></div>
    <p>Understanding pytest's mechanics makes everything else in this guide click immediately.</p>
    <p><strong>Test discovery.</strong> When you run <code>pytest</code>, it searches for files matching <code>test_*.py</code> or <code>*_test.py</code>. Inside those files, it collects functions named <code>test_*</code> and methods named <code>test_*</code> inside classes named <code>Test*</code>.</p>
    <p><strong>The fixture resolution chain.</strong> When pytest sees a test function with parameters, it treats those parameter names as fixture requests and resolves them through a lookup chain.</p>
    <div class="code-block">
      <div class="code-header"><span>fixture resolution flow</span></div>
      <pre><code>pytest collects: <span class="fn">test_create_article</span>(db, article_data)
                              ↓
pytest sees parameters: <span class="hl">'db'</span> and <span class="hl">'article_data'</span>
                              ↓
pytest resolves <span class="hl">'db'</span>           → built-in pytest-django fixture
pytest resolves <span class="hl">'article_data'</span> → found in conftest.py
                              ↓
pytest calls fixtures in dependency order
                              ↓
pytest calls <span class="fn">test_create_article</span>(db=&lt;database&gt;, article_data={...})</code></pre>
    </div>
    <p><strong>Fixture scope.</strong> Fixtures have a scope that controls how often they run. <code>function</code> scope (default) runs once per test. <code>class</code>, <code>module</code>, and <code>session</code> scopes share the fixture value across progressively more tests — making your suite faster.</p>
    <p><strong>conftest.py.</strong> Any fixtures defined in <code>conftest.py</code> are available to all tests in the same directory and all subdirectories, without any import statement. This is where shared fixtures live.</p>
  </section>

  <!-- S3 -->
  <section id="install">
    <span class="section-label">Section 03</span>
    <h2>Installation</h2>
    <div class="divider"></div>
    <div class="steps">
      <div class="step">
        <h3>Install pytest and pytest-django</h3>
        <div class="code-block">
          <div class="code-header"><span>bash</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
          <pre><code>pip install pytest pytest-django

<span class="cm"># or with uv (recommended)</span>
uv add pytest pytest-django --dev

<span class="cm"># or with poetry</span>
poetry add pytest pytest-django --group dev</code></pre>
        </div>
      </div>
      <div class="step">
        <h3>Install commonly used companions</h3>
        <div class="code-block">
          <div class="code-header"><span>bash</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
          <pre><code>pip install pytest-cov        <span class="cm"># coverage reporting</span>
pip install pytest-mock       <span class="cm"># cleaner mocking via the 'mocker' fixture</span>
pip install factory-boy       <span class="cm"># test data factories (strongly recommended)</span>
pip install pytest-factoryboy <span class="cm"># integrates factory_boy with pytest fixtures</span>
pip install pytest-xdist      <span class="cm"># run tests in parallel across CPU cores</span>
pip install Faker             <span class="cm"># realistic fake data for factories</span></code></pre>
        </div>
      </div>
      <div class="step">
        <h3>Tell pytest which Django settings to use</h3>
        <p>pytest-django needs to know your Django settings module. Set it in your config file (see Section 4) or via an environment variable:</p>
        <div class="code-block">
          <div class="code-header"><span>bash</span></div>
          <pre><code>DJANGO_SETTINGS_MODULE=myproject.settings pytest</code></pre>
        </div>
        <div class="callout tip">
          <strong>Tip</strong>
          <p>The config file approach is better — you can never forget to set the variable.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- S4 -->
  <section id="config">
    <span class="section-label">Section 04</span>
    <h2>Configuration</h2>
    <div class="divider"></div>
    <p><code>pyproject.toml</code> is the modern standard. Use <code>pytest.ini</code> if your project does not yet use <code>pyproject.toml</code>.</p>
    <div class="code-block">
      <div class="code-header"><span>pyproject.toml — recommended</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>[tool.pytest.ini_options]
<span class="cm"># Tell pytest-django where your settings module is</span>
DJANGO_SETTINGS_MODULE = <span class="st">"myproject.settings"</span>

<span class="cm"># Where to look for tests</span>
testpaths = [<span class="st">"tests"</span>]

<span class="cm"># Register custom marks to avoid PytestUnknownMarkWarning</span>
markers = [
    <span class="st">"slow: marks tests as slow (deselect with '-m not slow')"</span>,
    <span class="st">"integration: marks tests requiring external services"</span>,
    <span class="st">"unit: marks fast, isolated unit tests"</span>,
    <span class="st">"smoke: marks the minimal subset for basic sanity checks"</span>,
]

<span class="cm"># Default flags added to every pytest invocation</span>
addopts = <span class="st">"-v --tb=short"</span></code></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span>settings/test.py — faster test settings</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">from</span> .base <span class="kw">import</span> *

<span class="cm"># MD5 is ~100x faster than bcrypt for tests — no real passwords involved</span>
PASSWORD_HASHERS = [<span class="st">'django.contrib.auth.hashers.MD5PasswordHasher'</span>]

<span class="cm"># In-memory cache instead of Redis (no external dependency)</span>
CACHES = {<span class="st">'default'</span>: {<span class="st">'BACKEND'</span>: <span class="st">'django.core.cache.backends.locmem.LocMemCache'</span>}}

<span class="cm"># Celery tasks run synchronously in the same process</span>
CELERY_TASK_ALWAYS_EAGER = <span class="hl2">True</span>
CELERY_TASK_EAGER_PROPAGATES = <span class="hl2">True</span></code></pre>
    </div>

    <h3>Useful pytest CLI flags</h3>
    <div class="cmd-grid">
      <div class="cmd-item"><code>pytest -v</code><span>Verbose output</span></div>
      <div class="cmd-item"><code>pytest -x</code><span>Stop on first failure</span></div>
      <div class="cmd-item"><code>pytest -s</code><span>Show stdout (disable capture)</span></div>
      <div class="cmd-item"><code>pytest -k "article"</code><span>Run tests matching keyword</span></div>
      <div class="cmd-item"><code>pytest -m slow</code><span>Run tests with mark</span></div>
      <div class="cmd-item"><code>pytest --lf</code><span>Re-run last failures only</span></div>
      <div class="cmd-item"><code>pytest --ff</code><span>Last failures first, then rest</span></div>
      <div class="cmd-item"><code>pytest --durations=10</code><span>Show 10 slowest tests</span></div>
      <div class="cmd-item"><code>pytest --reuse-db</code><span>Skip DB recreation</span></div>
      <div class="cmd-item"><code>pytest -n auto</code><span>Parallel (pytest-xdist)</span></div>
    </div>
  </section>

  <!-- S5 -->
  <section id="first">
    <span class="section-label">Section 05</span>
    <h2>Your First Django Test</h2>
    <div class="divider"></div>
    <p>Create a <code>tests/</code> directory at the root of your project. pytest-django requires no special imports — just write functions.</p>
    <div class="code-block">
      <div class="code-header"><span>project layout</span></div>
      <pre><code>myproject/
├── myapp/
│   ├── models.py
│   ├── views.py
│   └── urls.py
├── tests/
│   ├── conftest.py          <span class="cm">← shared fixtures</span>
│   ├── test_models.py
│   ├── test_views.py
│   └── test_forms.py
├── pyproject.toml
└── manage.py</code></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span>tests/test_models.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">import</span> pytest
<span class="kw">from</span> myapp.models <span class="kw">import</span> Article


<span class="cm"># Pure unit test — no database, runs instantly</span>
<span class="kw">def</span> <span class="fn">test_article_str_representation</span>():
    article = Article(title=<span class="st">'Hello World'</span>)
    <span class="kw">assert</span> str(article) == <span class="st">'Hello World'</span>


<span class="cm"># Database test — requires @pytest.mark.django_db</span>
<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_article_save_and_retrieve</span>():
    Article.objects.create(title=<span class="st">'Saved Article'</span>, body=<span class="st">'Some content'</span>)
    retrieved = Article.objects.get(title=<span class="st">'Saved Article'</span>)
    <span class="kw">assert</span> retrieved.body == <span class="st">'Some content'</span>


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_article_slug_auto_generated</span>():
    article = Article.objects.create(title=<span class="st">'My First Article'</span>)
    <span class="kw">assert</span> article.slug == <span class="st">'my-first-article'</span></code></pre>
    </div>
    <div class="callout note">
      <strong>Critical rule</strong>
      <p><code>@pytest.mark.django_db</code> is required for any test that touches the database. Without it, database access raises an error intentionally — it makes the boundary between pure tests and database-dependent tests explicit and keeps pure tests fast.</p>
    </div>
    <h3>The <code>db</code> fixture vs <code>@pytest.mark.django_db</code></h3>
    <div class="code-block">
      <div class="code-header"><span>two equivalent approaches</span></div>
      <pre><code><span class="cm"># Using the mark — most common for standalone functions</span>
<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_something</span>():
    ...

<span class="cm"># Using the fixture — necessary when a fixture itself needs db access</span>
<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">article</span>(db):          <span class="cm"># ← request 'db' here</span>
    <span class="kw">return</span> Article.objects.create(title=<span class="st">'Test Article'</span>)

<span class="kw">def</span> <span class="fn">test_with_fixture</span>(article):   <span class="cm"># db access granted transitively</span>
    <span class="kw">assert</span> article.title == <span class="st">'Test Article'</span></code></pre>
    </div>
  </section>

  <!-- S6 -->
  <section id="fixtures">
    <span class="section-label">Section 06</span>
    <h2>Fixtures — The Core of pytest</h2>
    <div class="divider"></div>
    <p>Fixtures are pytest's replacement for <code>setUp</code>/<code>tearDown</code>. They are regular functions decorated with <code>@pytest.fixture</code> that return a value. Tests declare which fixtures they need as function parameters.</p>
    <div class="code-block">
      <div class="code-header"><span>tests/conftest.py — basic fixtures</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">import</span> pytest
<span class="kw">from</span> myapp.models <span class="kw">import</span> Article, Author


<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">author</span>():
    <span class="st">"""A simple Author instance (not saved to database)."""</span>
    <span class="kw">return</span> Author(name=<span class="st">'Jane Doe'</span>, email=<span class="st">'jane@example.com'</span>)


<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">author_in_db</span>(db):
    <span class="st">"""An Author instance saved to the database."""</span>
    <span class="kw">return</span> Author.objects.create(name=<span class="st">'Jane Doe'</span>, email=<span class="st">'jane@example.com'</span>)


<span class="cm"># Fixtures can request other fixtures</span>
<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">article</span>(db, author_in_db):
    <span class="kw">return</span> Article.objects.create(
        title=<span class="st">'Test Article'</span>,
        author=author_in_db,
        body=<span class="st">'Some content'</span>,
    )</code></pre>
    </div>

    <h3>Fixture scope</h3>
    <div class="code-block">
      <div class="code-header"><span>scope options</span></div>
      <pre><code><span class="dec">@pytest.fixture</span>(scope=<span class="st">'function'</span>)  <span class="cm"># default — runs once per test</span>
<span class="kw">def</span> <span class="fn">fresh_object</span>(): ...

<span class="dec">@pytest.fixture</span>(scope=<span class="st">'class'</span>)     <span class="cm"># runs once per test class</span>
<span class="kw">def</span> <span class="fn">class_data</span>(): ...

<span class="dec">@pytest.fixture</span>(scope=<span class="st">'module'</span>)    <span class="cm"># runs once per test file</span>
<span class="kw">def</span> <span class="fn">parsed_data</span>(): ...

<span class="dec">@pytest.fixture</span>(scope=<span class="st">'session'</span>)   <span class="cm"># runs once for the entire test run</span>
<span class="kw">def</span> <span class="fn">readonly_reference_data</span>(): ...</code></pre>
    </div>

    <h3>Fixtures with teardown using <code>yield</code></h3>
    <div class="code-block">
      <div class="code-header"><span>yield-based teardown</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">temp_media_dir</span>(tmp_path, settings):
    media_root = tmp_path / <span class="st">'media'</span>
    media_root.mkdir()

    <span class="cm"># Everything before yield = setUp</span>
    settings.MEDIA_ROOT = str(media_root)
    <span class="kw">yield</span> media_root

    <span class="cm"># Everything after yield = tearDown (runs even if test fails)</span>
    <span class="cm"># tmp_path cleanup is automatic; add explicit cleanup here if needed</span>


<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">patched_stripe</span>(mocker):
    mock = mocker.patch(<span class="st">'myapp.payments.stripe'</span>)
    mock.Charge.create.return_value = {<span class="st">'id'</span>: <span class="st">'ch_test_123'</span>, <span class="st">'status'</span>: <span class="st">'succeeded'</span>}
    <span class="kw">yield</span> mock
    <span class="cm"># mocker handles restoration automatically</span></code></pre>
    </div>
  </section>

  <!-- S7 -->
  <section id="djfixtures">
    <span class="section-label">Section 07</span>
    <h2>Django-Specific Fixtures</h2>
    <div class="divider"></div>
    <p>pytest-django provides built-in fixtures for common Django testing needs. No imports required — pytest finds them automatically.</p>
    <table class="data-table">
      <thead><tr><th>Fixture</th><th>Description</th></tr></thead>
      <tbody>
        <tr><td>db</td><td>Grants database access for the test. Wraps test in a transaction (rolled back after).</td></tr>
        <tr><td>transactional_db</td><td>Like <code>db</code> but allows real commits (needed for <code>on_commit</code>, <code>select_for_update</code>).</td></tr>
        <tr><td>client</td><td>An unauthenticated Django test client.</td></tr>
        <tr><td>admin_client</td><td>A test client logged in as an admin superuser.</td></tr>
        <tr><td>admin_user</td><td>The admin User object itself.</td></tr>
        <tr><td>rf</td><td>Django's RequestFactory — creates request objects without going through middleware.</td></tr>
        <tr><td>settings</td><td>Live-override Django settings for one test. Restores automatically after.</td></tr>
        <tr><td>mailoutbox</td><td>Captures all outgoing emails as a list. See Section 19.</td></tr>
        <tr><td>django_user_model</td><td>The User model — respects a custom <code>AUTH_USER_MODEL</code>.</td></tr>
        <tr><td>live_server</td><td>A real HTTP server for integration/browser tests.</td></tr>
        <tr><td>tmp_path</td><td>A temporary directory unique to the test (built-in pytest fixture).</td></tr>
        <tr><td>capsys</td><td>Capture stdout/stderr output (built-in pytest fixture).</td></tr>
      </tbody>
    </table>
    <div class="code-block">
      <div class="code-header"><span>examples of built-in fixtures</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">def</span> <span class="fn">test_homepage</span>(client):
    response = client.get(<span class="st">'/'</span>)
    <span class="kw">assert</span> response.status_code == <span class="num">200</span>


<span class="kw">def</span> <span class="fn">test_admin_accessible</span>(admin_client):
    response = admin_client.get(<span class="st">'/admin/'</span>)
    <span class="kw">assert</span> response.status_code == <span class="num">200</span>


<span class="kw">def</span> <span class="fn">test_feature_flag_on</span>(client, settings):
    settings.FEATURE_NEW_UI = <span class="hl2">True</span>
    response = client.get(<span class="st">'/dashboard/'</span>)
    <span class="kw">assert</span> <span class="st">b'new-ui'</span> <span class="kw">in</span> response.content
    <span class="cm"># settings.FEATURE_NEW_UI restored to original value after this test</span>


<span class="kw">def</span> <span class="fn">test_create_user</span>(db, django_user_model):
    user = django_user_model.objects.create_user(
        username=<span class="st">'bob'</span>, password=<span class="st">'securepassword'</span>,
    )
    <span class="kw">assert</span> user.username == <span class="st">'bob'</span></code></pre>
    </div>
  </section>

  <!-- S8 -->
  <section id="database">
    <span class="section-label">Section 08</span>
    <h2>The Database and Transactions</h2>
    <div class="divider"></div>
    <p><strong>Default behavior: rollback after each test.</strong> By default, <code>@pytest.mark.django_db</code> wraps each test in a transaction that is rolled back after the test completes. Each test starts with a clean database state, tests are fully isolated, and no cleanup code is needed.</p>
    <div class="code-block">
      <div class="code-header"><span>isolation demonstration</span></div>
      <pre><code><span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_one</span>():
    Article.objects.create(title=<span class="st">'Test'</span>)
    <span class="kw">assert</span> Article.objects.count() == <span class="num">1</span>

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_two</span>():
    <span class="cm"># Article from test_one is gone — transaction was rolled back</span>
    <span class="kw">assert</span> Article.objects.count() == <span class="num">0</span></code></pre>
    </div>

    <h3><code>transaction=True</code> — For tests that need real commits</h3>
    <p>Some code uses <code>transaction.atomic()</code>, <code>select_for_update()</code>, <code>on_commit()</code> hooks, or multiple database connections. These need real transaction commits.</p>
    <div class="code-block">
      <div class="code-header"><span>real transaction test</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="dec">@pytest.mark.django_db</span>(transaction=<span class="hl2">True</span>)
<span class="kw">def</span> <span class="fn">test_on_commit_hook_fires</span>():
    <span class="st">"""on_commit callbacks only fire after a real COMMIT."""</span>
    <span class="kw">with</span> transaction.atomic():
        article = Article.objects.create(title=<span class="st">'Test'</span>)
    <span class="cm"># on_commit hooks fire here, after the real commit</span>
    <span class="kw">assert</span> <span class="fn">some_side_effect_happened</span>()</code></pre>
    </div>
    <div class="callout warning">
      <strong>Performance tradeoff</strong>
      <p><code>transaction=True</code> tests are slower because the database must be reset by truncating tables after each test rather than rolling back. Use it only when code actually requires real commits.</p>
    </div>

    <h3>Counting queries — catching N+1 problems</h3>
    <div class="code-block">
      <div class="code-header"><span>django_assert_num_queries</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">def</span> <span class="fn">test_no_n_plus_one</span>(client, django_assert_num_queries):
    <span class="cm"># Create 5 articles, each with a different author</span>
    <span class="kw">for</span> i <span class="kw">in</span> range(<span class="num">5</span>):
        author = Author.objects.create(name=<span class="kw">f</span><span class="st">'Author {i}'</span>)
        Article.objects.create(title=<span class="kw">f</span><span class="st">'Article {i}'</span>, author=author)

    <span class="cm"># Without select_related: 1 (articles) + 5 (authors) = 6 queries</span>
    <span class="cm"># With select_related: exactly 2 queries</span>
    <span class="kw">with</span> django_assert_num_queries(<span class="num">2</span>):
        client.get(reverse(<span class="st">'article-list'</span>))</code></pre>
    </div>
  </section>

  <!-- S9 -->
  <section id="models">
    <span class="section-label">Section 09</span>
    <h2>Testing Models</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>tests/test_models.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">import</span> pytest
<span class="kw">from</span> django.utils <span class="kw">import</span> timezone
<span class="kw">from</span> django.core.exceptions <span class="kw">import</span> ValidationError
<span class="kw">from</span> myapp.models <span class="kw">import</span> Article


<span class="cm"># ── Pure unit tests (no DB, runs instantly) ────────────────────────────────</span>

<span class="kw">def</span> <span class="fn">test_article_str</span>():
    article = Article(title=<span class="st">'My Title'</span>)
    <span class="kw">assert</span> str(article) == <span class="st">'My Title'</span>


<span class="kw">def</span> <span class="fn">test_unpublished_article_is_not_published</span>():
    article = Article(published_at=<span class="hl2">None</span>)
    <span class="kw">assert</span> article.is_published() <span class="kw">is False</span>


<span class="kw">def</span> <span class="fn">test_word_count</span>():
    article = Article(body=<span class="st">'one two three four five'</span>)
    <span class="kw">assert</span> article.word_count() == <span class="num">5</span>


<span class="cm"># ── Database tests ─────────────────────────────────────────────────────────</span>

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_slug_auto_generated_from_title</span>():
    article = Article.objects.create(title=<span class="st">'Hello World'</span>)
    <span class="kw">assert</span> article.slug == <span class="st">'hello-world'</span>


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_title_max_length_validation</span>():
    article = Article(title=<span class="st">'x'</span> * <span class="num">201</span>, body=<span class="st">''</span>)
    <span class="kw">with</span> pytest.raises(ValidationError) <span class="kw">as</span> exc_info:
        article.full_clean()
    <span class="kw">assert</span> <span class="st">'title'</span> <span class="kw">in</span> exc_info.value.message_dict


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_published_manager_filters_correctly</span>():
    Article.objects.create(title=<span class="st">'Draft'</span>, body=<span class="st">''</span>)
    Article.objects.create(title=<span class="st">'Live'</span>, body=<span class="st">''</span>, published_at=timezone.now())
    <span class="kw">assert</span> Article.objects.count() == <span class="num">2</span>
    <span class="kw">assert</span> Article.published.count() == <span class="num">1</span>
    <span class="kw">assert</span> Article.published.first().title == <span class="st">'Live'</span></code></pre>
    </div>
  </section>

  <!-- S10 -->
  <section id="views">
    <span class="section-label">Section 10</span>
    <h2>Testing Views and URLs</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>tests/conftest.py — auth fixtures</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">import</span> pytest

<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">user</span>(db):
    <span class="kw">from</span> django.contrib.auth.models <span class="kw">import</span> User
    <span class="kw">return</span> User.objects.create_user(
        username=<span class="st">'testuser'</span>, password=<span class="st">'testpassword123'</span>,
    )

<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">authenticated_client</span>(client, user):
    <span class="cm"># force_login skips password hashing — much faster</span>
    client.force_login(user)
    <span class="kw">return</span> client

<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">staff_client</span>(client, db):
    <span class="kw">from</span> django.contrib.auth.models <span class="kw">import</span> User
    staff = User.objects.create_user(
        username=<span class="st">'staff'</span>, password=<span class="st">'pass'</span>, is_staff=<span class="hl2">True</span>
    )
    client.force_login(staff)
    <span class="kw">return</span> client</code></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span>tests/test_views.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">from</span> django.urls <span class="kw">import</span> reverse, resolve
<span class="kw">from</span> myapp.views <span class="kw">import</span> ArticleListView


<span class="cm"># URL resolution — no DB needed</span>
<span class="kw">def</span> <span class="fn">test_article_list_url</span>():
    <span class="kw">assert</span> reverse(<span class="st">'article-list'</span>) == <span class="st">'/articles/'</span>

<span class="kw">def</span> <span class="fn">test_article_list_resolves_to_view</span>():
    <span class="kw">assert</span> resolve(<span class="st">'/articles/'</span>).func.view_class <span class="kw">is</span> ArticleListView


<span class="cm"># Auth gate</span>
<span class="kw">def</span> <span class="fn">test_dashboard_requires_login</span>(client):
    response = client.get(reverse(<span class="st">'dashboard'</span>))
    <span class="kw">assert</span> response.status_code == <span class="num">302</span>
    <span class="kw">assert</span> <span class="st">'/login/'</span> <span class="kw">in</span> response[<span class="st">'Location'</span>]

<span class="kw">def</span> <span class="fn">test_dashboard_accessible_when_logged_in</span>(authenticated_client):
    response = authenticated_client.get(reverse(<span class="st">'dashboard'</span>))
    <span class="kw">assert</span> response.status_code == <span class="num">200</span>


<span class="cm"># POST, context, templates</span>
<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_create_article_via_post</span>(authenticated_client):
    response = authenticated_client.post(
        reverse(<span class="st">'article-create'</span>),
        data={<span class="st">'title'</span>: <span class="st">'New Article'</span>, <span class="st">'body'</span>: <span class="st">'Body text'</span>},
    )
    <span class="kw">assert</span> response.status_code == <span class="num">302</span>  <span class="cm"># redirect after success</span>
    <span class="kw">assert</span> Article.objects.filter(title=<span class="st">'New Article'</span>).exists()

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_article_detail_passes_article_to_context</span>(client):
    article = Article.objects.create(title=<span class="st">'Test'</span>, body=<span class="st">''</span>, slug=<span class="st">'test'</span>)
    response = client.get(reverse(<span class="st">'article-detail'</span>, kwargs={<span class="st">'slug'</span>: <span class="st">'test'</span>}))
    <span class="kw">assert</span> response.context[<span class="st">'article'</span>] == article</code></pre>
    </div>
  </section>

  <!-- S11 -->
  <section id="forms">
    <span class="section-label">Section 11</span>
    <h2>Testing Forms</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>tests/test_forms.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">import</span> pytest
<span class="kw">from</span> myapp.forms <span class="kw">import</span> ArticleForm


<span class="kw">def</span> <span class="fn">test_valid_form</span>():
    form = ArticleForm(data={<span class="st">'title'</span>: <span class="st">'My Article'</span>, <span class="st">'body'</span>: <span class="st">'Content here'</span>})
    <span class="kw">assert</span> form.is_valid()


<span class="kw">def</span> <span class="fn">test_empty_title_is_invalid</span>():
    form = ArticleForm(data={<span class="st">'title'</span>: <span class="st">''</span>, <span class="st">'body'</span>: <span class="st">'Content'</span>})
    <span class="kw">assert not</span> form.is_valid()
    <span class="kw">assert</span> <span class="st">'title'</span> <span class="kw">in</span> form.errors


<span class="kw">def</span> <span class="fn">test_title_test_rejected_by_custom_validation</span>():
    form = ArticleForm(data={<span class="st">'title'</span>: <span class="st">'test'</span>, <span class="st">'body'</span>: <span class="st">'Content'</span>})
    <span class="kw">assert not</span> form.is_valid()
    <span class="kw">assert</span> <span class="st">'title'</span> <span class="kw">in</span> form.errors
    <span class="kw">assert</span> <span class="st">"Please use a real title"</span> <span class="kw">in</span> form.errors[<span class="st">'title'</span>][<span class="num">0</span>]


<span class="kw">def</span> <span class="fn">test_form_saves_to_database</span>(db):
    form = ArticleForm(data={<span class="st">'title'</span>: <span class="st">'Saved Article'</span>, <span class="st">'body'</span>: <span class="st">'Body text'</span>})
    <span class="kw">assert</span> form.is_valid()
    article = form.save()
    <span class="kw">assert</span> article.pk <span class="kw">is not None</span>


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_form_edit_existing_instance</span>():
    article = Article.objects.create(title=<span class="st">'Original'</span>, body=<span class="st">'Body'</span>)
    form = ArticleForm(
        data={<span class="st">'title'</span>: <span class="st">'Updated'</span>, <span class="st">'body'</span>: <span class="st">'New body'</span>},
        instance=article,
    )
    <span class="kw">assert</span> form.is_valid()
    updated = form.save()
    <span class="kw">assert</span> updated.pk == article.pk  <span class="cm"># same object, updated in place</span>
    <span class="kw">assert</span> updated.title == <span class="st">'Updated'</span></code></pre>
    </div>
  </section>

  <!-- S12 -->
  <section id="drf">
    <span class="section-label">Section 12</span>
    <h2>Testing Django REST Framework APIs</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>tests/conftest.py — API client fixtures</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">import</span> pytest
<span class="kw">from</span> rest_framework.test <span class="kw">import</span> APIClient

<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">api_client</span>():
    <span class="kw">return</span> APIClient()

<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">authenticated_api_client</span>(api_client, user):
    api_client.force_authenticate(user=user)
    <span class="kw">return</span> api_client

<span class="dec">@pytest.fixture</span>
<span class="kw">def</span> <span class="fn">admin_api_client</span>(api_client, admin_user):
    api_client.force_authenticate(user=admin_user)
    <span class="kw">return</span> api_client</code></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span>tests/api/test_articles.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">from</span> rest_framework <span class="kw">import</span> status

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_list_requires_auth</span>(api_client):
    response = api_client.get(reverse(<span class="st">'api:article-list'</span>))
    <span class="kw">assert</span> response.status_code == status.HTTP_401_UNAUTHORIZED


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_create_article</span>(authenticated_api_client):
    response = authenticated_api_client.post(
        reverse(<span class="st">'api:article-list'</span>),
        data={<span class="st">'title'</span>: <span class="st">'New Article'</span>, <span class="st">'body'</span>: <span class="st">'Body'</span>},
        format=<span class="st">'json'</span>,
    )
    <span class="kw">assert</span> response.status_code == status.HTTP_201_CREATED
    <span class="kw">assert</span> response.data[<span class="st">'title'</span>] == <span class="st">'New Article'</span>


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_update_article</span>(authenticated_api_client, article):
    url = reverse(<span class="st">'api:article-detail'</span>, kwargs={<span class="st">'pk'</span>: article.pk})
    response = authenticated_api_client.put(
        url, data={<span class="st">'title'</span>: <span class="st">'Updated'</span>, <span class="st">'body'</span>: article.body}, format=<span class="st">'json'</span>
    )
    <span class="kw">assert</span> response.status_code == status.HTTP_200_OK
    article.refresh_from_db()
    <span class="kw">assert</span> article.title == <span class="st">'Updated'</span>


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_response_json_structure</span>(authenticated_api_client, article):
    response = authenticated_api_client.get(
        reverse(<span class="st">'api:article-detail'</span>, kwargs={<span class="st">'pk'</span>: article.pk})
    )
    <span class="kw">assert</span> response.status_code == status.HTTP_200_OK
    <span class="kw">assert</span> set(response.data.keys()) == {<span class="st">'id'</span>, <span class="st">'title'</span>, <span class="st">'body'</span>, <span class="st">'slug'</span>, <span class="st">'created_at'</span>}</code></pre>
    </div>
  </section>

  <!-- S13 -->
  <section id="parametrize">
    <span class="section-label">Section 13</span>
    <h2>Parametrize — One Test, Many Inputs</h2>
    <div class="divider"></div>
    <p><code>@pytest.mark.parametrize</code> runs a single test function multiple times with different arguments. It eliminates copy-pasted test functions and makes adding new cases trivial.</p>
    <div class="code-block">
      <div class="code-header"><span>parametrize basics</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">import</span> pytest
<span class="kw">from</span> myapp.utils <span class="kw">import</span> slugify_title


<span class="dec">@pytest.mark.parametrize</span>(<span class="st">'title, expected_slug'</span>, [
    (<span class="st">'Hello World'</span>,           <span class="st">'hello-world'</span>),
    (<span class="st">'Django Testing'</span>,         <span class="st">'django-testing'</span>),
    (<span class="st">'  Leading Spaces  '</span>,     <span class="st">'leading-spaces'</span>),
    (<span class="st">'Special! @#$ Characters'</span>, <span class="st">'special-characters'</span>),
    (<span class="st">'UPPERCASE'</span>,              <span class="st">'uppercase'</span>),
    (<span class="st">'already-a-slug'</span>,         <span class="st">'already-a-slug'</span>),
])
<span class="kw">def</span> <span class="fn">test_slugify_title</span>(title, expected_slug):
    <span class="kw">assert</span> <span class="fn">slugify_title</span>(title) == expected_slug</code></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span>with descriptive IDs and expected exceptions</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="dec">@pytest.mark.parametrize</span>(<span class="st">'email, is_valid'</span>, [
    pytest.param(<span class="st">'good@example.com'</span>,      <span class="hl2">True</span>,  id=<span class="st">'valid-standard'</span>),
    pytest.param(<span class="st">'user+tag@example.co.uk'</span>, <span class="hl2">True</span>,  id=<span class="st">'valid-plus-tag'</span>),
    pytest.param(<span class="st">'not-an-email'</span>,           <span class="hl2">False</span>, id=<span class="st">'invalid-no-at'</span>),
    pytest.param(<span class="st">'@example.com'</span>,           <span class="hl2">False</span>, id=<span class="st">'invalid-no-local'</span>),
    pytest.param(<span class="st">''</span>,                       <span class="hl2">False</span>, id=<span class="st">'invalid-empty'</span>),
])
<span class="kw">def</span> <span class="fn">test_email_validation</span>(email, is_valid):
    <span class="kw">assert</span> <span class="fn">validate_email_format</span>(email) == is_valid
<span class="cm"># Output: test_email_validation[valid-standard] PASSED
#         test_email_validation[invalid-no-at]  FAILED  ← clear which case failed</span>


<span class="cm"># Stacking parametrize generates a full matrix (4 × 2 = 8 tests)</span>
<span class="dec">@pytest.mark.parametrize</span>(<span class="st">'method'</span>, [<span class="st">'GET'</span>, <span class="st">'POST'</span>, <span class="st">'PUT'</span>, <span class="st">'DELETE'</span>])
<span class="dec">@pytest.mark.parametrize</span>(<span class="st">'path'</span>,   [<span class="st">'/articles/'</span>, <span class="st">'/articles/1/'</span>])
<span class="kw">def</span> <span class="fn">test_unauthenticated_requests_blocked</span>(client, method, path):
    response = getattr(client, method.lower())(path)
    <span class="kw">assert</span> response.status_code <span class="kw">in</span> (<span class="num">302</span>, <span class="num">401</span>, <span class="num">403</span>)</code></pre>
    </div>
  </section>

  <!-- S14 -->
  <section id="factories">
    <span class="section-label">Section 14</span>
    <h2>Factories with factory_boy</h2>
    <div class="divider"></div>
    <p>Hard-coding test data inside fixtures becomes brittle as your models grow. <code>factory_boy</code> lets you define a factory for each model that generates realistic test data with sensible defaults, with any field overridable per-test.</p>
    <div class="code-block">
      <div class="code-header"><span>tests/factories.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">import</span> factory
<span class="kw">from</span> factory.django <span class="kw">import</span> DjangoModelFactory
<span class="kw">from</span> django.utils <span class="kw">import</span> timezone
<span class="kw">from</span> django.utils.text <span class="kw">import</span> slugify
<span class="kw">from</span> django.contrib.auth.models <span class="kw">import</span> User
<span class="kw">from</span> myapp.models <span class="kw">import</span> Author, Article


<span class="kw">class</span> <span class="fn">UserFactory</span>(DjangoModelFactory):
    <span class="kw">class</span> Meta:
        model = User

    username = factory.Sequence(<span class="kw">lambda</span> n: <span class="kw">f</span><span class="st">'user_{n}'</span>)          <span class="cm"># unique</span>
    email    = factory.LazyAttribute(<span class="kw">lambda</span> obj: <span class="kw">f</span><span class="st">'{obj.username}@example.com'</span>)
    password = factory.PostGenerationMethodCall(<span class="st">'set_password'</span>, <span class="st">'testpassword'</span>)
    is_active = <span class="hl2">True</span>


<span class="kw">class</span> <span class="fn">AuthorFactory</span>(DjangoModelFactory):
    <span class="kw">class</span> Meta:
        model = Author

    name  = factory.Faker(<span class="st">'name'</span>)
    email = factory.Faker(<span class="st">'email'</span>)
    bio   = factory.Faker(<span class="st">'paragraph'</span>)


<span class="kw">class</span> <span class="fn">ArticleFactory</span>(DjangoModelFactory):
    <span class="kw">class</span> Meta:
        model = Article

    title        = factory.Faker(<span class="st">'sentence'</span>, nb_words=<span class="num">5</span>)
    body         = factory.Faker(<span class="st">'text'</span>, max_nb_chars=<span class="num">500</span>)
    author       = factory.SubFactory(AuthorFactory)  <span class="cm"># auto-creates related Author</span>
    slug         = factory.LazyAttribute(<span class="kw">lambda</span> obj: slugify(obj.title))
    published_at = <span class="hl2">None</span>                               <span class="cm"># draft by default</span>


<span class="kw">class</span> <span class="fn">PublishedArticleFactory</span>(ArticleFactory):
    <span class="st">"""An Article that is always published."""</span>
    published_at = factory.LazyFunction(timezone.now)</code></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span>using factories in tests</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_factory_creates_valid_article</span>():
    article = ArticleFactory()
    <span class="kw">assert</span> article.pk <span class="kw">is not None</span>
    <span class="kw">assert</span> article.title

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_override_specific_fields</span>():
    article = ArticleFactory(title=<span class="st">'Custom Title'</span>)
    <span class="kw">assert</span> article.title == <span class="st">'Custom Title'</span>

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_create_batch</span>():
    articles = ArticleFactory.create_batch(<span class="num">10</span>)
    <span class="kw">assert</span> Article.objects.count() == <span class="num">10</span>

<span class="kw">def</span> <span class="fn">test_build_does_not_hit_db</span>():
    article = ArticleFactory.build()  <span class="cm"># in-memory only — no DB needed</span>
    <span class="kw">assert</span> article.pk <span class="kw">is None</span>
    <span class="kw">assert</span> Article.objects.count() == <span class="num">0</span></code></pre>
    </div>
    <div class="callout tip">
      <strong>Auto-register as pytest fixtures</strong>
      <p>Add <code>pip install pytest-factoryboy</code> then in <code>conftest.py</code>: <code>from pytest_factoryboy import register; register(ArticleFactory)</code> — this creates an <code>article</code> fixture automatically.</p>
    </div>
  </section>

  <!-- S15 -->
  <section id="mocking">
    <span class="section-label">Section 15</span>
    <h2>Mocking — unittest.mock and pytest-mock</h2>
    <div class="divider"></div>
    <p>Mocking replaces real objects with controlled fakes. Use it to avoid calling real external services, control time, force specific return values, and verify that code called a function with the right arguments.</p>
    <div class="callout note">
      <strong>Always use mocker.patch</strong>
      <p>The <code>mocker</code> fixture from <code>pytest-mock</code> wraps <code>unittest.mock</code> but automatically restores all patches after the test. No more <code>patcher.stop()</code> calls.</p>
    </div>
    <div class="code-block">
      <div class="code-header"><span>patching and asserting calls</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="cm"># CRITICAL: patch the name as used in the module under test,</span>
<span class="cm"># not where it is defined. myapp.services.requests.get, NOT requests.get</span>

<span class="kw">def</span> <span class="fn">test_get_weather</span>(mocker):
    mock_response = mocker.MagicMock()
    mock_response.json.return_value = {<span class="st">'temperature'</span>: <span class="num">22</span>}
    mocker.patch(<span class="st">'myapp.services.requests.get'</span>, return_value=mock_response)

    result = <span class="fn">get_weather</span>(<span class="st">'London'</span>)
    <span class="kw">assert</span> result == <span class="num">22</span>


<span class="kw">def</span> <span class="fn">test_stripe_charge</span>(mocker):
    mock_stripe = mocker.patch(<span class="st">'myapp.payments.stripe'</span>)
    mock_stripe.Charge.create.return_value = {<span class="st">'id'</span>: <span class="st">'ch_test_123'</span>, <span class="st">'status'</span>: <span class="st">'succeeded'</span>}

    result = <span class="fn">charge_customer</span>(amount=<span class="num">1000</span>, token=<span class="st">'tok_test'</span>)

    <span class="kw">assert</span> result[<span class="st">'status'</span>] == <span class="st">'succeeded'</span>
    mock_stripe.Charge.create.assert_called_once_with(
        amount=<span class="num">1000</span>, currency=<span class="st">'usd'</span>, source=<span class="st">'tok_test'</span>,
    )


<span class="cm"># Freeze time for time-dependent tests</span>
<span class="kw">from</span> datetime <span class="kw">import</span> datetime
<span class="kw">from</span> django.utils <span class="kw">import</span> timezone

<span class="kw">def</span> <span class="fn">test_published_at_set_correctly</span>(mocker):
    frozen = datetime(<span class="num">2024</span>, <span class="num">6</span>, <span class="num">15</span>, <span class="num">12</span>, <span class="num">0</span>, <span class="num">0</span>, tzinfo=timezone.utc)
    mocker.patch(<span class="st">'django.utils.timezone.now'</span>, return_value=frozen)

    article = <span class="fn">publish_article</span>(Article(title=<span class="st">'Test'</span>))
    <span class="kw">assert</span> article.published_at == frozen</code></pre>
    </div>
  </section>

  <!-- S16 -->
  <section id="signals">
    <span class="section-label">Section 16</span>
    <h2>Testing Signals</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>tests/test_signals.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_welcome_email_sent_on_user_create</span>(mocker):
    <span class="st">"""The post_save signal on User should trigger a welcome email."""</span>
    mock_send = mocker.patch(<span class="st">'myapp.signals.send_welcome_email'</span>)

    User.objects.create_user(username=<span class="st">'newuser'</span>, email=<span class="st">'new@example.com'</span>, password=<span class="st">'pass'</span>)

    mock_send.assert_called_once_with(<span class="st">'new@example.com'</span>)


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_post_save_signal_fires_on_create</span>(mocker):
    <span class="kw">from</span> unittest.mock <span class="kw">import</span> MagicMock
    <span class="kw">from</span> django.db.models.signals <span class="kw">import</span> post_save

    handler = MagicMock()
    post_save.connect(handler, sender=Article)
    <span class="kw">try</span>:
        Article.objects.create(title=<span class="st">'Signal Test'</span>, body=<span class="st">'Body'</span>)
        handler.assert_called_once()
        _, kwargs = handler.call_args
        <span class="kw">assert</span> kwargs[<span class="st">'created'</span>] <span class="kw">is True</span>
    <span class="kw">finally</span>:
        post_save.disconnect(handler, sender=Article)


<span class="cm"># Disable all signals in tests to prevent side effects (emails, HTTP calls, etc.)</span>
<span class="dec">@pytest.fixture</span>(autouse=<span class="hl2">True</span>)
<span class="kw">def</span> <span class="fn">disable_signals</span>(mocker):
    mocker.patch(<span class="st">'myapp.signals.send_welcome_email'</span>)
    mocker.patch(<span class="st">'myapp.signals.notify_slack_on_publish'</span>)</code></pre>
    </div>
  </section>

  <!-- S17 -->
  <section id="celery">
    <span class="section-label">Section 17</span>
    <h2>Testing Celery Tasks</h2>
    <div class="divider"></div>
    <p>The simplest and most reliable approach: test the task's business logic directly, bypassing Celery infrastructure entirely.</p>
    <div class="code-block">
      <div class="code-header"><span>tests/test_tasks.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="cm"># myapp/tasks.py</span>
<span class="dec">@app.task</span>
<span class="kw">def</span> <span class="fn">process_article</span>(article_id):
    article = Article.objects.get(pk=article_id)
    article.word_count_cache = len(article.body.split())
    article.save()
    <span class="kw">return</span> article.word_count_cache


<span class="cm"># tests/test_tasks.py</span>
<span class="kw">from</span> myapp.tasks <span class="kw">import</span> process_article

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_process_article_computes_word_count</span>():
    article = Article.objects.create(title=<span class="st">'Test'</span>, body=<span class="st">'one two three four five'</span>)

    <span class="cm"># Call the underlying function directly — not .delay() or .apply_async()</span>
    result = <span class="fn">process_article</span>(article.pk)

    article.refresh_from_db()
    <span class="kw">assert</span> result == <span class="num">5</span>
    <span class="kw">assert</span> article.word_count_cache == <span class="num">5</span>


<span class="cm"># Or use CELERY_TASK_ALWAYS_EAGER=True in test settings</span>
<span class="cm"># and call .delay() — tasks run synchronously in the same process</span>
<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_task_with_eager_mode</span>():
    article = Article.objects.create(title=<span class="st">'Test'</span>, body=<span class="st">'one two three'</span>)
    result = process_article.delay(article.pk)
    <span class="kw">assert</span> result.successful()
    <span class="kw">assert</span> result.get() == <span class="num">3</span></code></pre>
    </div>
  </section>

  <!-- S18 -->
  <section id="email">
    <span class="section-label">Section 18</span>
    <h2>Testing Email</h2>
    <div class="divider"></div>
    <p>pytest-django's <code>mailoutbox</code> fixture captures all emails sent via Django's email backend and exposes them as a list.</p>
    <div class="code-block">
      <div class="code-header"><span>tests/test_email.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_password_reset_email_content</span>(mailoutbox):
    <span class="fn">send_password_reset</span>(email=<span class="st">'user@example.com'</span>, reset_link=<span class="st">'https://example.com/reset/abc'</span>)

    <span class="kw">assert</span> len(mailoutbox) == <span class="num">1</span>
    email = mailoutbox[<span class="num">0</span>]
    <span class="kw">assert</span> email.subject == <span class="st">'Reset your password'</span>
    <span class="kw">assert</span> <span class="st">'user@example.com'</span> <span class="kw">in</span> email.to
    <span class="kw">assert</span> <span class="st">'https://example.com/reset/abc'</span> <span class="kw">in</span> email.body


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_order_confirmation_sends_html_email</span>(mailoutbox):
    <span class="fn">send_order_confirmation</span>(order_id=<span class="num">42</span>, email=<span class="st">'buyer@example.com'</span>)

    <span class="kw">assert</span> len(mailoutbox) == <span class="num">1</span>
    html_content, content_type = mailoutbox[<span class="num">0</span>].alternatives[<span class="num">0</span>]
    <span class="kw">assert</span> content_type == <span class="st">'text/html'</span>
    <span class="kw">assert</span> <span class="st">'&lt;h1&gt;Order Confirmed&lt;/h1&gt;'</span> <span class="kw">in</span> html_content


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_no_email_sent_for_unverified_user</span>(mailoutbox):
    user = User.objects.create_user(username=<span class="st">'new'</span>, email_verified=<span class="hl2">False</span>)
    <span class="fn">send_weekly_digest</span>(user)
    <span class="kw">assert</span> len(mailoutbox) == <span class="num">0</span></code></pre>
    </div>
  </section>

  <!-- S19 -->
  <section id="files">
    <span class="section-label">Section 19</span>
    <h2>Testing File Uploads</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>tests/test_uploads.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">from</span> django.core.files.uploadedfile <span class="kw">import</span> SimpleUploadedFile

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_profile_picture_upload</span>(authenticated_client):
    image = SimpleUploadedFile(
        name=<span class="st">'profile.png'</span>,
        content=<span class="st">b'\x89PNG\r\n\x1a\n'</span> + <span class="st">b'\x00'</span> * <span class="num">100</span>,
        content_type=<span class="st">'image/png'</span>,
    )
    response = authenticated_client.post(
        reverse(<span class="st">'profile-upload'</span>),
        data={<span class="st">'profile_picture'</span>: image},
        format=<span class="st">'multipart'</span>,
    )
    <span class="kw">assert</span> response.status_code == <span class="num">302</span>


<span class="cm"># Redirect all file writes to a temp directory per test</span>
<span class="dec">@pytest.fixture</span>(autouse=<span class="hl2">True</span>)
<span class="kw">def</span> <span class="fn">use_temp_media_dir</span>(tmp_path, settings):
    settings.MEDIA_ROOT = str(tmp_path / <span class="st">'media'</span>)
    settings.DEFAULT_FILE_STORAGE = <span class="st">'django.core.files.storage.FileSystemStorage'</span></code></pre>
    </div>
  </section>

  <!-- S20 -->
  <section id="commands">
    <span class="section-label">Section 20</span>
    <h2>Testing Management Commands</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>tests/test_commands.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="kw">from</span> io <span class="kw">import</span> StringIO
<span class="kw">from</span> django.core.management <span class="kw">import</span> call_command

<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_purge_old_articles_command</span>():
    <span class="kw">from</span> datetime <span class="kw">import</span> timedelta
    old   = Article.objects.create(title=<span class="st">'Old'</span>,  body=<span class="st">''</span>, created_at=timezone.now() - timedelta(days=<span class="num">60</span>))
    fresh = Article.objects.create(title=<span class="st">'New'</span>,  body=<span class="st">''</span>)

    out = StringIO()
    <span class="fn">call_command</span>(<span class="st">'purge_old_articles'</span>, days=<span class="num">30</span>, stdout=out)

    <span class="kw">assert not</span> Article.objects.filter(pk=old.pk).exists()
    <span class="kw">assert</span>     Article.objects.filter(pk=fresh.pk).exists()
    <span class="kw">assert</span> <span class="st">'1 article(s) deleted'</span> <span class="kw">in</span> out.getvalue()


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_import_from_csv</span>(tmp_path):
    csv_file = tmp_path / <span class="st">'articles.csv'</span>
    csv_file.write_text(<span class="st">'title,body\nImported Article,Body\n'</span>)

    <span class="fn">call_command</span>(<span class="st">'import_articles'</span>, str(csv_file))

    <span class="kw">assert</span> Article.objects.filter(title=<span class="st">'Imported Article'</span>).exists()</code></pre>
    </div>
  </section>

  <!-- S21 -->
  <section id="auth">
    <span class="section-label">Section 21</span>
    <h2>Testing Authentication and Permissions</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>tests/test_auth.py</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_login_with_valid_credentials</span>(client, user):
    response = client.post(reverse(<span class="st">'login'</span>), {
        <span class="st">'username'</span>: <span class="st">'testuser'</span>, <span class="st">'password'</span>: <span class="st">'testpassword123'</span>,
    })
    <span class="kw">assert</span> response.status_code == <span class="num">302</span>
    <span class="kw">assert</span> response[<span class="st">'Location'</span>] == reverse(<span class="st">'dashboard'</span>)


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_login_with_invalid_credentials</span>(client):
    response = client.post(reverse(<span class="st">'login'</span>), {
        <span class="st">'username'</span>: <span class="st">'nobody'</span>, <span class="st">'password'</span>: <span class="st">'wrong'</span>,
    })
    <span class="kw">assert</span> response.status_code == <span class="num">200</span>


<span class="cm"># Object-level permissions</span>
<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_user_can_edit_own_article</span>(authenticated_client, user):
    article = Article.objects.create(title=<span class="st">'Mine'</span>, body=<span class="st">''</span>, author=user)
    response = authenticated_client.post(
        reverse(<span class="st">'article-edit'</span>, kwargs={<span class="st">'pk'</span>: article.pk}),
        data={<span class="st">'title'</span>: <span class="st">'Updated'</span>, <span class="st">'body'</span>: <span class="st">'Updated body'</span>},
    )
    <span class="kw">assert</span> response.status_code == <span class="num">302</span>


<span class="dec">@pytest.mark.django_db</span>
<span class="kw">def</span> <span class="fn">test_user_cannot_edit_others_article</span>(authenticated_client):
    other = User.objects.create_user(username=<span class="st">'other'</span>, password=<span class="st">'pass'</span>)
    article = Article.objects.create(title=<span class="st">'Not Mine'</span>, body=<span class="st">''</span>, author=other)
    response = authenticated_client.post(
        reverse(<span class="st">'article-edit'</span>, kwargs={<span class="st">'pk'</span>: article.pk}),
        data={<span class="st">'title'</span>: <span class="st">'Hacked'</span>, <span class="st">'body'</span>: <span class="st">'Hacked'</span>},
    )
    <span class="kw">assert</span> response.status_code == <span class="num">403</span></code></pre>
    </div>
  </section>

  <!-- S22 -->
  <section id="markers">
    <span class="section-label">Section 22</span>
    <h2>Markers — Categorizing Tests</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>built-in and custom markers</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="cm"># Skip unconditionally</span>
<span class="dec">@pytest.mark.skip</span>(reason=<span class="st">'Not implemented yet'</span>)
<span class="kw">def</span> <span class="fn">test_future_feature</span>(): ...

<span class="cm"># Skip conditionally</span>
<span class="kw">import</span> sys
<span class="dec">@pytest.mark.skipif</span>(sys.platform == <span class="st">'win32'</span>, reason=<span class="st">'Unix only'</span>)
<span class="kw">def</span> <span class="fn">test_unix_only</span>(): ...

<span class="cm"># Expected failure</span>
<span class="dec">@pytest.mark.xfail</span>(reason=<span class="st">'Known bug in upstream lib, fixed in v2.0'</span>)
<span class="kw">def</span> <span class="fn">test_known_broken</span>(): ...

<span class="cm"># Custom marks (register in pyproject.toml to avoid warnings)</span>
<span class="dec">@pytest.mark.slow</span>
<span class="kw">def</span> <span class="fn">test_expensive_computation</span>(): ...

<span class="dec">@pytest.mark.integration</span>
<span class="kw">def</span> <span class="fn">test_payment_gateway</span>(live_server): ...

<span class="cm"># Run only unit tests:              pytest -m unit</span>
<span class="cm"># Exclude slow tests:               pytest -m "not slow"</span>
<span class="cm"># Exclude integration (local dev):  pytest -m "not integration"</span></code></pre>
    </div>
    <h3><code>autouse</code> — run a fixture for all tests automatically</h3>
    <div class="code-block">
      <div class="code-header"><span>autouse fixture</span></div>
      <pre><code><span class="dec">@pytest.fixture</span>(autouse=<span class="hl2">True</span>)
<span class="kw">def</span> <span class="fn">reset_rate_limiter</span>():
    <span class="st">"""Clear the rate limiter cache before and after each test."""</span>
    rate_limit_cache.clear()
    <span class="kw">yield</span>
    rate_limit_cache.clear()</code></pre>
    </div>
  </section>

  <!-- S23 -->
  <section id="coverage">
    <span class="section-label">Section 23</span>
    <h2>Coverage with pytest-cov</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>bash — coverage commands</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code><span class="cm"># Terminal report with missing lines highlighted</span>
pytest --cov=myapp --cov-report=term-missing tests/

<span class="cm"># HTML report (open htmlcov/index.html in browser)</span>
pytest --cov=myapp --cov-report=html tests/

<span class="cm"># Fail if coverage drops below threshold</span>
pytest --cov=myapp --cov-fail-under=80 tests/

<span class="cm"># Combine reports</span>
pytest --cov=myapp --cov-report=term-missing --cov-report=html --cov-fail-under=80</code></pre>
    </div>
    <div class="code-block">
      <div class="code-header"><span>pyproject.toml — coverage config</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>[tool.coverage.run]
source = [<span class="st">"myapp"</span>]
omit   = [<span class="st">"*/migrations/*"</span>, <span class="st">"*/tests/*"</span>, <span class="st">"manage.py"</span>]

[tool.coverage.report]
exclude_lines = [
    <span class="st">"pragma: no cover"</span>,
    <span class="st">"def __repr__"</span>,
    <span class="st">"raise NotImplementedError"</span>,
    <span class="st">"if TYPE_CHECKING:"</span>,
]
fail_under = <span class="num">80</span>

[tool.coverage.html]
directory = <span class="st">"htmlcov"</span></code></pre>
    </div>
  </section>

  <!-- S24 -->
  <section id="perf">
    <span class="section-label">Section 24</span>
    <h2>Performance — Speeding Up Your Suite</h2>
    <div class="divider"></div>
    <div class="two-col">
      <div class="card">
        <h4>Quick wins</h4>
        <ul>
          <li>Use <code>MD5PasswordHasher</code> in test settings (~100× faster)</li>
          <li>Use <code>factory.build()</code> instead of <code>create()</code> when DB not needed</li>
          <li>Use <code>bulk_create()</code> instead of looping <code>create()</code></li>
          <li>Use <code>force_login()</code> instead of <code>client.login()</code></li>
          <li>Run <code>pytest --reuse-db</code> to skip DB recreation</li>
        </ul>
      </div>
      <div class="card">
        <h4>Bigger improvements</h4>
        <ul>
          <li><code>pytest -n auto</code> — run in parallel with pytest-xdist</li>
          <li>Profile with <code>pytest --durations=10</code></li>
          <li>Use <code>scope='session'</code> for read-only fixtures</li>
          <li>Split slow integration tests into a separate suite</li>
          <li>Use in-memory SQLite for tests that don't need PostgreSQL features</li>
        </ul>
      </div>
    </div>
    <div class="callout warning">
      <strong>Parallel testing caveat</strong>
      <p>Parallel testing with <code>pytest-xdist</code> requires tests to be truly isolated. If tests share state (global caches, file paths, specific database IDs), parallel execution will cause intermittent failures that are hard to debug.</p>
    </div>
  </section>

  <!-- S25 -->
  <section id="ci">
    <span class="section-label">Section 25</span>
    <h2>Running Tests in CI</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>.github/workflows/test.yml — GitHub Actions</span><button class="copy-btn" onclick="copyCode(this)">Copy</button></div>
      <pre><code>name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports: [<span class="st">"5432:5432"</span>]
        options: --health-cmd pg_isready --health-interval 10s --health-retries 5
      redis:
        image: redis:7
        ports: [<span class="st">"6379:6379"</span>]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: <span class="st">'3.12'</span> }

      - name: Install dependencies
        run: pip install -r requirements/test.txt

      - name: Run tests
        env:
          DJANGO_SETTINGS_MODULE: myproject.settings.test
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0
        run: pytest --cov=myapp --cov-report=xml --cov-fail-under=80

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with: { file: coverage.xml }</code></pre>
    </div>
  </section>

  <!-- S26 -->
  <section id="layout">
    <span class="section-label">Section 26</span>
    <h2>Project Layout and Organization</h2>
    <div class="divider"></div>
    <div class="code-block">
      <div class="code-header"><span>recommended directory structure</span></div>
      <pre><code>myproject/
├── myapp/
│   ├── migrations/
│   ├── models.py
│   ├── views.py
│   ├── forms.py
│   ├── serializers.py
│   ├── tasks.py
│   └── signals.py
├── tests/
│   ├── conftest.py           <span class="cm">← shared fixtures, factory registration</span>
│   ├── factories.py          <span class="cm">← all factory_boy factories</span>
│   ├── test_models.py
│   ├── test_views.py
│   ├── test_forms.py
│   ├── test_tasks.py
│   ├── test_signals.py
│   ├── test_commands.py
│   └── api/
│       ├── conftest.py       <span class="cm">← API-specific fixtures</span>
│       ├── test_articles.py
│       └── test_users.py
├── pyproject.toml
└── manage.py</code></pre>
    </div>
    <div class="callout info">
      <strong>Test naming convention</strong>
      <p>Use <code>test_&lt;thing&gt;_&lt;condition&gt;_&lt;expected_result&gt;</code> pattern. Examples: <code>test_article_create_without_title_fails</code>, <code>test_dashboard_unauthenticated_redirects</code>, <code>test_payment_stripe_error_raises_exception</code>. Clear names act as living documentation.</p>
    </div>
  </section>

  <!-- S27 -->
  <section id="pitfalls">
    <span class="section-label">Section 27</span>
    <h2>Common Pitfalls &amp; Troubleshooting</h2>
    <div class="divider"></div>

    <div class="pitfall">
      <div class="pitfall-problem">⚠ django.core.exceptions.ImproperlyConfigured: Requested setting DATABASES...</div>
      <div class="pitfall-body">
        <span class="cause">Cause: pytest-django cannot find your Django settings module.</span>
        <p>Add <code>DJANGO_SETTINGS_MODULE = "myproject.settings"</code> to your <code>[tool.pytest.ini_options]</code> in <code>pyproject.toml</code>.</p>
      </div>
    </div>

    <div class="pitfall">
      <div class="pitfall-problem">⚠ Failed: Database access not allowed, use the 'django_db' mark</div>
      <div class="pitfall-body">
        <span class="cause">Cause: Your test or a fixture it uses is accessing the database without requesting database access.</span>
        <p>Add <code>@pytest.mark.django_db</code> to the test, or add <code>db</code> as a parameter to the fixture that needs database access.</p>
      </div>
    </div>

    <div class="pitfall">
      <div class="pitfall-problem">⚠ Tests pass in isolation but fail when run together</div>
      <div class="pitfall-body">
        <span class="cause">Cause: Tests are not properly isolated. One test creates state that another test depends on not existing.</span>
        <p>Ensure all DB-modifying tests use <code>@pytest.mark.django_db</code> (not <code>transaction=True</code> unless necessary). Check for <code>autouse</code> fixtures that share state. Avoid <code>scope='session'</code> for mutable data.</p>
      </div>
    </div>

    <div class="pitfall">
      <div class="pitfall-problem">⚠ mocker.patch is not restoring the original after the test</div>
      <div class="pitfall-body">
        <span class="cause">Cause: You're using unittest.mock.patch directly instead of mocker.patch.</span>
        <p>Always use <code>mocker.patch</code> from the <code>pytest-mock</code> <code>mocker</code> fixture. It registers all patches for automatic cleanup and you never need to call <code>patcher.stop()</code>.</p>
      </div>
    </div>

    <div class="pitfall">
      <div class="pitfall-problem">⚠ factory_boy raises IntegrityError on unique fields</div>
      <div class="pitfall-body">
        <span class="cause">Cause: factory.Faker or a static default is generating duplicate values for a unique field.</span>
        <div class="code-block" style="margin:0.5rem 0 0">
          <div class="code-header"><span>fix — use Sequence for unique fields</span></div>
          <pre><code><span class="kw">class</span> <span class="fn">UserFactory</span>(DjangoModelFactory):
    username = factory.Sequence(<span class="kw">lambda</span> n: <span class="kw">f</span><span class="st">'user_{n}'</span>)
    email    = factory.Sequence(<span class="kw">lambda</span> n: <span class="kw">f</span><span class="st">'user_{n}@example.com'</span>)</code></pre>
        </div>
      </div>
    </div>

    <div class="pitfall">
      <div class="pitfall-problem">⚠ fixture 'db' not found when using scope='module' fixtures</div>
      <div class="pitfall-body">
        <span class="cause">Cause: The 'db' fixture has function scope by default. Higher-scope fixtures cannot depend on lower-scope fixtures.</span>
        <p>Use <code>django_db_blocker</code> for session-scoped database access: <code>with django_db_blocker.unblock(): ...</code></p>
      </div>
    </div>

    <div class="pitfall">
      <div class="pitfall-problem">⚠ Tests work locally but fail in CI with ALLOWED_HOSTS error</div>
      <div class="pitfall-body">
        <span class="cause">Cause: ALLOWED_HOSTS does not include 'testserver' — Django's default test server hostname.</span>
        <p>In your test settings: <code>ALLOWED_HOSTS = ['testserver', 'localhost', '127.0.0.1']</code></p>
      </div>
    </div>
  </section>

  <!-- S28 -->
  <section id="checklist">
    <span class="section-label">Section 28</span>
    <h2>Checklist</h2>
    <div class="divider"></div>
    <p>Use this every time you add testing infrastructure to a Django project.</p>

    <div class="checklist-group">
      <h4>Initial Setup</h4>
      <ul class="checklist">
        <li><code>pytest</code>, <code>pytest-django</code>, <code>pytest-cov</code>, <code>pytest-mock</code>, <code>factory-boy</code> are installed</li>
        <li><code>DJANGO_SETTINGS_MODULE</code> is set in <code>pyproject.toml</code> or <code>pytest.ini</code></li>
        <li>A dedicated test settings file exists with a faster password hasher</li>
        <li><code>conftest.py</code> is created at the project root with shared fixtures</li>
        <li>Custom markers are declared in <code>pyproject.toml</code> to avoid warnings</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Writing Tests</h4>
      <ul class="checklist">
        <li>Every test touching the database uses <code>@pytest.mark.django_db</code> or the <code>db</code> fixture</li>
        <li>Tests needing real transactions use <code>@pytest.mark.django_db(transaction=True)</code></li>
        <li>Test names follow the <code>test_&lt;thing&gt;_&lt;condition&gt;_&lt;result&gt;</code> convention</li>
        <li>Tests do not depend on each other or on execution order</li>
        <li>No hardcoded primary keys or database IDs in tests</li>
        <li>All user creation uses <code>create_user()</code> or <code>force_login()</code></li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Fixtures</h4>
      <ul class="checklist">
        <li>Shared fixtures live in <code>conftest.py</code>, not imported between test files</li>
        <li>Fixtures that access the database request <code>db</code> or <code>transactional_db</code></li>
        <li><code>yield</code> is used for fixtures that need teardown</li>
        <li><code>autouse=True</code> is used sparingly and only for truly universal setup</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Factories</h4>
      <ul class="checklist">
        <li>A <code>factories.py</code> file exists with a factory for every major model</li>
        <li>Unique fields use <code>factory.Sequence</code> to avoid <code>IntegrityError</code></li>
        <li><code>SubFactory</code> is used for FK relationships</li>
        <li>Factories use <code>build()</code> in tests that don't need the database</li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Mocking</h4>
      <ul class="checklist">
        <li><code>mocker.patch</code> (from pytest-mock) is used instead of <code>unittest.mock.patch</code> directly</li>
        <li>Patches target the name as used in the module under test, not where defined</li>
        <li>Time-dependent code uses the <code>settings</code> fixture or <code>mocker.patch</code> on <code>timezone.now</code></li>
      </ul>
    </div>

    <div class="checklist-group">
      <h4>Coverage &amp; CI</h4>
      <ul class="checklist">
        <li><code>pytest-cov</code> is configured to report coverage for the project source</li>
        <li>Migrations and test files are excluded from coverage</li>
        <li>A minimum coverage threshold (<code>--cov-fail-under</code>) is set in CI</li>
        <li>Database and Redis services are configured in the CI workflow</li>
        <li>The correct <code>DJANGO_SETTINGS_MODULE</code> is set in CI environment variables</li>
      </ul>
    </div>

  </section>

</div>

<footer>
  <p>
    <a href="https://docs.pytest.org/" target="_blank">pytest docs</a>
    <span class="sep">·</span>
    <a href="https://pytest-django.readthedocs.io/" target="_blank">pytest-django docs</a>
    <span class="sep">·</span>
    <a href="https://factoryboy.readthedocs.io/" target="_blank">factory_boy docs</a>
    <span class="sep">·</span>
    <a href="https://pytest-mock.readthedocs.io/" target="_blank">pytest-mock docs</a>
  </p>
</footer>

<script>
  function copyCode(btn) {
    const pre = btn.closest('.code-block').querySelector('pre');
    navigator.clipboard.writeText(pre.innerText).then(() => {
      const orig = btn.textContent;
      btn.textContent = 'Copied!';
      btn.style.color = '#f5c400';
      btn.style.borderColor = '#f5c400';
      setTimeout(() => {
        btn.textContent = orig;
        btn.style.color = '';
        btn.style.borderColor = '';
      }, 1800);
    });
  }
</script>
</body>
</html>